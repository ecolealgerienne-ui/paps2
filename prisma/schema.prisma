generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

// ENUM pour les maladies cibl√©es par les vaccins
enum VaccineTargetDisease {
  brucellosis
  bluetongue
  foot_and_mouth
  rabies
  anthrax
  lumpy_skin
  ppr          // Peste Petits Ruminants
  sheep_pox
  enterotoxemia
  pasteurellosis
  other
}

// ENUM pour types de campagnes nationales
enum CampaignType {
  vaccination
  deworming
  screening
  treatment
  census
  other
}

// ENUM pour types de produits m√©dicaux
enum MedicalProductType {
  antibiotic
  anti_inflammatory
  antiparasitic
  vitamin
  mineral
  vaccine
  anesthetic
  hormone
  other
}

// ENUM pour cat√©gories d'alertes
enum AlertCategory {
  health
  vaccination
  treatment
  reproduction
  nutrition
  administrative
  other
}

// ENUM pour priorit√©s d'alertes
enum AlertPriority {
  low
  medium
  high
  urgent
}

// ENUM pour status de campagnes personnelles
enum PersonalCampaignStatus {
  planned
  in_progress
  completed
  cancelled
}

// ENUM pour le scope des donn√©es ma√Ætres (Master Table Pattern)
enum DataScope {
  global  // Donn√©es globales, cr√©√©es par admin, utilisables par toutes les fermes
  local   // Donn√©es locales, cr√©√©es par fermier, sp√©cifiques √† une ferme
}

// ENUM pour types de produits (unifi√© m√©dicaments + vaccins)
enum ProductType {
  antibiotic
  anti_inflammatory
  antiparasitic
  vitamin
  mineral
  vaccine
  anesthetic
  hormone
  antiseptic
  analgesic
  other
}

// ENUM pour type de traitement (traitement vs vaccination)
enum TreatmentType {
  treatment
  vaccination
}

// ENUM pour type de vaccination (obligatoire, recommand√©e, optionnelle)
enum VaccinationType {
  mandatory
  recommended
  optional
}

// ENUM pour type d'unit√© de mesure
enum UnitType {
  mass          // mg, g, kg
  volume        // ml, L
  concentration // mg/ml, UI/ml
  count         // comprim√©s, doses
  percentage    // %
  other
}

// ENUM pour type de statut physiologique animal
enum AnimalStatusType {
  WEIGHT        // Poids
  GESTATION     // Gestation
  LACTATION     // Lactation
  VET_CHECK     // Contr√¥le v√©t√©rinaire
}

// ENUM pour unit√© de dosage personnalis√© (surcharge √©leveur)
enum DoseUnitType {
  ML_PER_KG     // ml/kg
  ML_PER_HEAD   // ml/t√™te
  MG_PER_KG     // mg/kg
  G_PER_HEAD    // g/t√™te
}

// ============================================================
// TABLES DE R√âF√âRENCE (Backend)
// ============================================================

// Table de r√©f√©rence - Unit√©s de mesure
model Unit {
  id              String    @id @default(uuid())
  code            String    @unique              // "mg", "ml", "kg", "g", "UI", "mg_per_ml"
  symbol          String                         // "mg", "ml", "kg", "g", "UI", "mg/ml"
  nameFr          String    @map("name_fr")
  nameEn          String    @map("name_en")
  nameAr          String    @map("name_ar")
  unitType        UnitType  @map("unit_type")
  description     String?
  baseUnitCode    String?   @map("base_unit_code")  // Pour conversions (ex: "g" pour "mg")
  conversionFactor Float?   @map("conversion_factor") // Facteur de conversion vers unit√© de base
  displayOrder    Int       @default(0) @map("display_order")
  isActive        Boolean   @default(true) @map("is_active")
  version         Int       @default(1)
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  productPackagingsConcentration ProductPackaging[] @relation("ConcentrationUnit")
  productPackagingsVolume        ProductPackaging[] @relation("VolumeUnit")
  therapeuticIndicationsDose     TherapeuticIndication[] @relation("DoseUnit")
  treatmentsQuantity             Treatment[] @relation("QuantityUnit")

  @@index([code])
  @@index([unitType])
  @@index([isActive])
  @@index([deletedAt])
  @@map("units")
}

// Table de r√©f√©rence - Cat√©gories d'√¢ge par esp√®ce
model AgeCategory {
  id           String    @id @default(uuid())
  code         String                          // "calf", "young", "adult" - unique par esp√®ce
  speciesId    String    @map("species_id")
  nameFr       String    @map("name_fr")
  nameEn       String    @map("name_en")
  nameAr       String    @map("name_ar")
  description  String?
  ageMinDays   Int       @map("age_min_days")   // 0 pour nouveau-n√©
  ageMaxDays   Int?      @map("age_max_days")   // NULL = pas de limite (adulte)
  displayOrder Int       @default(0) @map("display_order")
  isDefault    Boolean   @default(false) @map("is_default")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  species      Species   @relation(fields: [speciesId], references: [id])
  therapeuticIndications TherapeuticIndication[]

  @@unique([speciesId, code])
  @@index([speciesId])
  @@index([code])
  @@index([isActive])
  @@index([deletedAt])
  @@index([speciesId, isActive, deletedAt])
  @@index([speciesId, ageMinDays, ageMaxDays])
  @@map("age_categories")
}

// Table de r√©f√©rence - Substances actives
model ActiveSubstance {
  id          String    @id @default(uuid())
  code        String    @unique               // Code interne unique
  name        String                          // Nom international (DCI)
  nameFr      String?   @map("name_fr")
  nameEn      String?   @map("name_en")
  nameAr      String?   @map("name_ar")
  atcCode     String?   @map("atc_code")      // Code ATC/ATCvet (ex: QJ01MA90)
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  version     Int       @default(1)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  products    Product[]

  @@index([code])
  @@index([atcCode])
  @@index([isActive])
  @@index([deletedAt])
  @@map("active_substances")
}

// Table de r√©f√©rence - Cat√©gories de produits
model ProductCategory {
  id           String    @id @default(uuid())
  code         String    @unique               // "antibiotics", "vaccines", "vitamins"
  nameFr       String    @map("name_fr")
  nameEn       String    @map("name_en")
  nameAr       String    @map("name_ar")
  description  String?
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  products     Product[]

  @@index([code])
  @@index([isActive])
  @@index([deletedAt])
  @@map("product_categories")
}

// Table de r√©f√©rence - Esp√®ces
model Species {
  id             String    @id                 // Existant : "bovine", "ovine", "caprine"
  nameFr         String    @map("name_fr")
  nameEn         String    @map("name_en")
  nameAr         String    @map("name_ar")
  icon           String
  displayOrder   Int       @default(0) @map("display_order")
  description    String?
  scientificName String?   @map("scientific_name")  // Nom scientifique (ex: "Bos taurus")

  // M√©tadonn√©es
  version     Int       @default(1)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  animals       Animal[]
  breeds        Breed[]
  ageCategories AgeCategory[]
  therapeuticIndications TherapeuticIndication[]
  farmSpeciesPreferences FarmSpeciesPreference[]

  // Indexes
  @@index([deletedAt])

  @@map("species")
}

// Table de r√©f√©rence - Races (PHASE_12)
model Breed {
  id           String    @id @default(uuid())
  code         String    @unique              // Code unique (ex: "lacaune", "holstein")
  speciesId    String    @map("species_id")
  nameFr       String    @map("name_fr")
  nameEn       String    @map("name_en")
  nameAr       String    @map("name_ar")
  description  String?
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  species Species  @relation(fields: [speciesId], references: [id])
  animals Animal[]
  breedCountries  BreedCountry[]       // PHASE_16
  farmPreferences FarmBreedPreference[] // PHASE_20

  // Indexes simples
  @@index([speciesId])
  @@index([code])
  @@index([deletedAt])
  @@index([displayOrder])
  @@index([isActive])

  // Index composites (RECOMMANDATIONS - performance)
  @@index([speciesId, isActive, deletedAt])  // Query: races actives d'une esp√®ce
  @@index([speciesId, displayOrder])         // Query: races tri√©es par esp√®ce

  @@map("breeds")
}

// Table de r√©f√©rence - Pays (ISO 3166-1)
model Country {
  code      String   @id           // ISO 3166-1 alpha-2 (ex: "FR", "DZ")
  nameFr    String   @map("name_fr")
  nameEn    String   @map("name_en")
  nameAr    String   @map("name_ar")
  region    String?  // "Europe", "Africa", "Asia", "Americas", "Oceania"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  breedCountries         BreedCountry[]
  campaignCountries      CampaignCountry[]
  productPackagings      ProductPackaging[]
  therapeuticIndications TherapeuticIndication[]

  @@index([isActive])
  @@index([region])
  @@map("countries")
}

// Table de liaison - Breeds ‚Üî Countries (PHASE_16)
model BreedCountry {
  id          String    @id @default(uuid())
  breedId     String    @map("breed_id")
  countryCode String    @map("country_code")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  breed   Breed   @relation(fields: [breedId], references: [id], onDelete: Cascade)
  country Country @relation(fields: [countryCode], references: [code], onDelete: Cascade)

  @@unique([breedId, countryCode])
  @@index([breedId])
  @@index([countryCode])
  @@index([isActive])
  @@map("breed_countries")
}

// Table de r√©f√©rence - Campagnes Nationales (PHASE_07)
model NationalCampaign {
  id              String        @id @default(uuid())
  code            String        @unique
  nameFr          String        @map("name_fr")
  nameEn          String        @map("name_en")
  nameAr          String        @map("name_ar")
  description     String?
  type            CampaignType
  startDate       DateTime      @map("start_date")
  endDate         DateTime      @map("end_date")
  isActive        Boolean       @default(true) @map("is_active")
  version         Int           @default(1)
  deletedAt       DateTime?     @map("deleted_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations (BLOC 3 & BLOC 4)
  campaignCountries CampaignCountry[]  // PHASE_19
  farmPreferences   FarmNationalCampaignPreference[]  // PHASE_24

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([deletedAt])
  @@map("national_campaigns")
}

// Table de liaison - NationalCampaign ‚Üî Countries (PHASE_19)
model CampaignCountry {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  countryCode String   @map("country_code")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  campaign NationalCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  country  Country          @relation(fields: [countryCode], references: [code], onDelete: Cascade)

  @@unique([campaignId, countryCode])
  @@index([campaignId])
  @@index([countryCode])
  @@index([isActive])
  @@map("campaign_countries")
}

// Table de pr√©f√©rences - Farm ‚Üî Breeds (PHASE_20)
model FarmBreedPreference {
  id           String    @id @default(uuid())
  farmId       String    @map("farm_id")
  breedId      String    @map("breed_id")
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  farm  Farm  @relation(fields: [farmId], references: [id], onDelete: Cascade)
  breed Breed @relation(fields: [breedId], references: [id], onDelete: Cascade)

  @@unique([farmId, breedId])
  @@index([farmId])
  @@index([breedId])
  @@index([displayOrder])
  @@index([farmId, deletedAt])
  @@map("farm_breed_preferences")
}

// Table de pr√©f√©rences - Farm ‚Üî Species
model FarmSpeciesPreference {
  id           String    @id @default(uuid())
  farmId       String    @map("farm_id")
  speciesId    String    @map("species_id")
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  farm    Farm    @relation(fields: [farmId], references: [id], onDelete: Cascade)
  species Species @relation(fields: [speciesId], references: [id], onDelete: Cascade)

  @@unique([farmId, speciesId])
  @@index([farmId])
  @@index([speciesId])
  @@index([displayOrder])
  @@index([farmId, deletedAt])
  @@map("farm_species_preferences")
}


// ============================================================
// TABLES MA√éTRES CONSOLID√âES (Master Table Pattern)
// ============================================================

// Produit unifi√© (m√©dicaments + vaccins)
// Remplace MedicalProduct + Vaccine
model Product {
  id                        String              @id @default(uuid())

  // SCOPE PATTERN
  scope                     DataScope           // "global" | "local"
  farmId                    String?             @map("farm_id")  // NULL si global, SET si local

  // Identification
  code                      String?             @unique  // Obligatoire pour global, optionnel pour local
  nameFr                    String              @map("name_fr")
  nameEn                    String?             @map("name_en")
  nameAr                    String?             @map("name_ar")
  commercialName            String?             @map("commercial_name")
  description               String?

  // Classification
  type                      ProductType?        // antibiotic, vaccine, antiparasitic, etc.
  categoryId                String?             @map("category_id")
  substanceId               String?             @map("substance_id")
  atcVetCode                String?             @map("atc_vet_code")  // Code ATCvet (ex: QJ01MA90)

  // Fabrication
  manufacturer              String?
  form                      String?             // injectable, oral, topical, powder, tablet

  // Sp√©cifique vaccins (type = vaccine)
  targetDisease             String?             @map("target_disease")  // Maladie cibl√©e
  immunityDurationDays      Int?                @map("immunity_duration_days")  // Dur√©e immunit√© en jours

  // M√©tadonn√©es
  notes                     String?
  isActive                  Boolean             @default(true) @map("is_active")
  version                   Int                 @default(1)
  deletedAt                 DateTime?           @map("deleted_at")
  createdAt                 DateTime            @default(now()) @map("created_at")
  updatedAt                 DateTime            @updatedAt @map("updated_at")

  // Relations
  farm                      Farm?               @relation(fields: [farmId], references: [id], onDelete: Cascade)
  category                  ProductCategory?    @relation(fields: [categoryId], references: [id])
  substance                 ActiveSubstance?    @relation(fields: [substanceId], references: [id])
  packagings                ProductPackaging[]
  indications               TherapeuticIndication[]
  treatments                Treatment[]
  lots                      Lot[]
  personalCampaigns         PersonalCampaign[]
  farmPreferences           FarmProductPreference[]

  // Indexes simples
  @@index([scope])
  @@index([farmId])
  @@index([code])
  @@index([type])
  @@index([categoryId])
  @@index([substanceId])
  @@index([manufacturer])
  @@index([isActive])
  @@index([deletedAt])

  // Indexes composites (performance)
  @@index([scope, farmId])
  @@index([scope, isActive])
  @@index([scope, isActive, deletedAt])
  @@index([farmId, isActive, deletedAt])
  @@index([type, isActive, deletedAt])

  @@map("products")
}

// Conditionnement produit par pays
model ProductPackaging {
  id                    String    @id @default(uuid())
  productId             String    @map("product_id")
  countryCode           String    @map("country_code")

  // Concentration
  concentration         Float                           // Ex: 100 (pour 100 mg/ml)
  concentrationUnitId   String    @map("concentration_unit_id")

  // Volume/Quantit√©
  volume                Float?                          // Ex: 100 (pour 100 ml)
  volumeUnitId          String?   @map("volume_unit_id")
  packagingLabel        String    @map("packaging_label")  // "Flacon 100ml", "Bo√Æte 10 comprim√©s"

  // Identification commerciale
  gtinEan               String?   @map("gtin_ean")      // Code barre EAN/GTIN
  numeroAMM             String?   @map("numero_amm")    // AMM sp√©cifique au pays

  // M√©tadonn√©es
  isActive              Boolean   @default(true) @map("is_active")
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  product               Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  country               Country   @relation(fields: [countryCode], references: [code], onDelete: Cascade)
  concentrationUnit     Unit      @relation("ConcentrationUnit", fields: [concentrationUnitId], references: [id])
  volumeUnit            Unit?     @relation("VolumeUnit", fields: [volumeUnitId], references: [id])
  treatments            Treatment[]
  farmPreferences       FarmProductPreference[]

  @@unique([productId, countryCode, gtinEan])
  @@index([productId])
  @@index([countryCode])
  @@index([gtinEan])
  @@index([isActive])
  @@index([deletedAt])
  @@index([productId, countryCode])
  @@map("product_packagings")
}

// Indication th√©rapeutique (posologie + temps d'attente)
model TherapeuticIndication {
  id                    String    @id @default(uuid())
  productId             String    @map("product_id")
  countryCode           String?   @map("country_code")  // NULL = r√®gle universelle
  speciesId             String    @map("species_id")
  ageCategoryId         String?   @map("age_category_id")  // NULL = tous √¢ges
  routeId               String    @map("route_id")

  // Posologie
  doseMin               Float?    @map("dose_min")      // mg/kg minimum
  doseMax               Float?    @map("dose_max")      // mg/kg maximum
  doseUnitId            String?   @map("dose_unit_id")
  doseOriginalText      String?   @map("dose_original_text")  // Texte RCP original
  protocolDurationDays  Int?      @map("protocol_duration_days")

  // Temps d'attente (CRITIQUE pour tra√ßabilit√©)
  withdrawalMeatDays    Int       @map("withdrawal_meat_days")
  withdrawalMilkDays    Int?      @map("withdrawal_milk_days")

  // Validation
  isVerified            Boolean   @default(false) @map("is_verified")
  validationNotes       String?   @map("validation_notes")

  // M√©tadonn√©es
  isActive              Boolean   @default(true) @map("is_active")
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  product               Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  country               Country?  @relation(fields: [countryCode], references: [code])
  species               Species   @relation(fields: [speciesId], references: [id])
  ageCategory           AgeCategory? @relation(fields: [ageCategoryId], references: [id])
  route                 AdministrationRoute @relation(fields: [routeId], references: [id])
  doseUnit              Unit?     @relation("DoseUnit", fields: [doseUnitId], references: [id])
  treatments            Treatment[]

  @@unique([productId, countryCode, speciesId, ageCategoryId, routeId])
  @@index([productId])
  @@index([countryCode])
  @@index([speciesId])
  @@index([ageCategoryId])
  @@index([routeId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([productId, speciesId, routeId])
  @@map("therapeutic_indications")
}

// V√©t√©rinaires (Master Table Pattern - multi-scope)
model Veterinarian {
  id                    String    @id @default(uuid())

  // üÜï SCOPE PATTERN
  scope                 DataScope @default(local)  // "global" | "local"
  farmId                String?   @map("farm_id")  // NULL si global, SET si local

  firstName             String    @map("first_name")
  lastName              String    @map("last_name")
  title                 String?
  licenseNumber         String?   @map("license_number")  // Obligatoire pour global, optionnel pour local
  specialties           String?   // comma-separated or JSON string - Optionnel pour local
  clinic                String?
  phone                 String?   // Obligatoire pour global, optionnel pour local
  mobile                String?
  email                 String?
  address               String?
  city                  String?
  postalCode            String?   @map("postal_code")
  country               String?

  // Champs g√©ographiques
  department            String?   // Ex: "81", "2A"
  commune               String?   // Ex: "81004"
  isAvailable           Boolean   @default(true) @map("is_available")
  emergencyService      Boolean   @default(false) @map("emergency_service")
  workingHours          String?   @map("working_hours")
  consultationFee       Float?    @map("consultation_fee")
  emergencyFee          Float?    @map("emergency_fee")
  currency              String?
  notes                 String?
  isPreferred           Boolean   @default(false) @map("is_preferred")
  isDefault             Boolean   @default(false) @map("is_default")
  rating                Int       @default(5)
  totalInterventions    Int       @default(0) @map("total_interventions")
  lastInterventionDate  DateTime? @map("last_intervention_date")
  isActive              Boolean   @default(true) @map("is_active")
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  farm Farm? @relation(fields: [farmId], references: [id], onDelete: Cascade)
  treatments Treatment[]
  farmPreferences FarmVeterinarianPreference[]

  // Index simples
  @@index([scope])
  @@index([farmId])
  @@index([deletedAt])
  @@index([isActive])
  @@index([isDefault])
  @@index([department])

  // Index composites
  @@index([scope, farmId])
  @@index([scope, isActive])
  @@index([farmId, isActive, deletedAt])
  @@index([department, isActive])
  @@index([farmId, isDefault])

  @@map("veterinarians")
}

// Table de r√©f√©rence - Voies d'administration
model AdministrationRoute {
  id           String    @id @default(uuid())
  code         String    @unique                // "oral", "injectable", "topical", etc.
  nameFr       String    @map("name_fr")
  nameEn       String    @map("name_en")
  nameAr       String    @map("name_ar")
  abbreviation String?                          // "PO", "IM", "IV", "SC", "TOP"
  description  String?
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  treatments             Treatment[]
  therapeuticIndications TherapeuticIndication[]

  // Indexes
  @@index([code])
  @@index([isActive])
  @@index([deletedAt])

  @@map("administration_routes")
}


// Templates d'alertes (catalogue global)
model AlertTemplate {
  id              String         @id @default(uuid())
  code            String         @unique
  nameFr          String         @map("name_fr")
  nameEn          String         @map("name_en")
  nameAr          String         @map("name_ar")
  descriptionFr   String?        @map("description_fr")
  descriptionEn   String?        @map("description_en")
  descriptionAr   String?        @map("description_ar")
  category        AlertCategory
  priority        AlertPriority  @default(medium)
  isActive        Boolean        @default(true) @map("is_active")
  version         Int            @default(1)
  deletedAt       DateTime?      @map("deleted_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@index([code])
  @@index([category])
  @@index([priority])
  @@index([isActive])
  @@index([deletedAt])
  @@map("alert_templates")
}

// ============================================================
// TABLES DE R√âF√âRENCE (Configuration)
// ============================================================

// Table de r√©f√©rence - Configuration des alertes
model AlertConfiguration {
  id                      String    @id @default(uuid())
  farmId                  String    @unique @map("farm_id")
  enableEmailAlerts       Boolean   @default(true) @map("enable_email_alerts")
  enableSmsAlerts         Boolean   @default(false) @map("enable_sms_alerts")
  enablePushAlerts        Boolean   @default(true) @map("enable_push_alerts")
  vaccinationReminderDays Int       @default(7) @map("vaccination_reminder_days")
  treatmentReminderDays   Int       @default(3) @map("treatment_reminder_days")
  healthCheckReminderDays Int       @default(30) @map("health_check_reminder_days")
  version                 Int       @default(1)
  deletedAt               DateTime? @map("deleted_at")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("alert_configurations")
}

// ============================================================
// TABLES PRINCIPALES
// ============================================================

// Ferme
model Farm {
  id            String    @id
  ownerId       String    @map("owner_id")
  groupId       String?   @map("group_id")
  name          String
  address       String?
  postalCode    String?   @map("postal_code")
  city          String?

  // Champs g√©ographiques
  country       String?   // Code ISO 3166-1 alpha-2 (ex: "FR", "DZ")
  department    String?   // Code d√©partement (ex: "81", "2A")
  commune       String?   // Code INSEE commune (ex: "81004")

  latitude      Float?
  longitude     Float?

  // Champs existants (compatibilit√©)
  location      String
  cheptelNumber String?   @map("cheptel_number")
  groupName     String?   @map("group_name")

  isDefault     Boolean   @default(false) @map("is_default")

  // Activation/d√©sactivation
  isActive      Boolean   @default(true) @map("is_active")

  // Soft delete, versioning, timestamps
  version       Int       @default(1)
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  animals Animal[]
  lots Lot[]
  movements Movement[]
  personalCampaigns PersonalCampaign[]
  documents Document[]
  weights Weight[]
  treatments Treatment[]
  breedings Breeding[]
  lotAnimals LotAnimal[]
  veterinarians Veterinarian[]
  products Product[]               // Produits locaux (scope='local')
  preferences FarmPreferences?
  alertConfigurations AlertConfiguration[]
  campaignPreferences FarmNationalCampaignPreference[]
  veterinarianPreferences FarmVeterinarianPreference[]
  breedPreferences FarmBreedPreference[]
  productPreferences FarmProductPreference[]
  speciesPreferences FarmSpeciesPreference[]

  // Indexes
  @@index([ownerId])
  @@index([groupId])
  @@index([isDefault])
  @@index([isActive])
  @@index([deletedAt])
  @@index([country])
  @@index([department])

  // Index composites (RECOMMENDATIONS)
  @@index([ownerId, isActive, deletedAt])
  @@index([country, department])
  @@index([ownerId, isDefault])

  @@map("farms")
}

// Animal
model Animal {
  id                    String    @id
  farmId                String    @map("farm_id")
  currentLocationFarmId String?   @map("current_location_farm_id")
  currentEid            String?   @map("current_eid")
  officialNumber        String?   @map("official_number")
  visualId              String?   @map("visual_id")
  eidHistory            String?   @map("eid_history")
  birthDate             DateTime  @map("birth_date")
  sex                   String
  motherId              String?   @map("mother_id")
  fatherId              String?   @map("father_id")
  speciesId             String?   @map("species_id")
  breedId               String?   @map("breed_id")
  status                String    @default("alive")
  validatedAt           DateTime? @map("validated_at")
  photoUrl              String?   @map("photo_url")
  notes                 String?
  days                  Int?
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  farm     Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  species  Species? @relation(fields: [speciesId], references: [id])
  breed    Breed?   @relation(fields: [breedId], references: [id])
  mother   Animal?  @relation("Parentage", fields: [motherId], references: [id])
  children Animal[] @relation("Parentage")

  lotAnimals LotAnimal[]
  treatments Treatment[]
  weights Weight[]
  breedingsAsMother Breeding[] @relation("BreedingMother")
  breedingsAsFather Breeding[] @relation("BreedingFather")
  movementAnimals MovementAnimal[]
  statusHistory AnimalStatusHistory[]

  @@unique([farmId, currentEid])
  @@unique([farmId, officialNumber])
  @@index([farmId])
  @@index([status])
  @@index([deletedAt])
  @@map("animals")
}

// Historique des statuts physiologiques de l'animal
model AnimalStatusHistory {
  id          String            @id @default(uuid())
  animalId    String            @map("animal_id")
  statusType  AnimalStatusType  @map("status_type")
  startDate   DateTime          @map("start_date")
  endDate     DateTime?         @map("end_date")
  value       String
  notes       String?
  version     Int               @default(1)
  deletedAt   DateTime?         @map("deleted_at")
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  // Relations
  animal      Animal            @relation(fields: [animalId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([animalId])
  @@index([statusType])
  @@index([deletedAt])
  @@index([animalId, statusType, endDate])  // Requ√™te statut actif
  @@index([animalId, deletedAt])

  @@map("animal_status_history")
}

// ============================================================
// TABLES APP (Donn√©es utilisateur)
// ============================================================

// Lot (groupe d'animaux)
model Lot {
  id                String    @id @default(uuid())
  farmId            String    @map("farm_id")
  name              String
  type              String?   // treatment, sale, slaughter, purchase
  status            String    @default("open") // open, closed, archived
  description       String?
  completed         Boolean   @default(false)
  completedAt       DateTime? @map("completed_at")
  productId         String?   @map("product_id")  // üÜï FK vers MedicalProduct (Master Table)
  productName       String?   @map("product_name") // Garder pour tra√ßabilit√© historique
  treatmentDate     DateTime? @map("treatment_date")
  withdrawalEndDate DateTime? @map("withdrawal_end_date")
  veterinarianId    String?   @map("veterinarian_id")
  veterinarianName  String?   @map("veterinarian_name")
  priceTotal        Float?    @map("price_total")
  buyerName         String?   @map("buyer_name")
  sellerName        String?   @map("seller_name")
  notes             String?
  isActive          Boolean   @default(true) @map("is_active")
  version           Int       @default(1)
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  lotAnimals LotAnimal[]
  personalCampaigns PersonalCampaign[]

  @@index([farmId])
  @@index([productId])
  @@index([deletedAt])
  @@map("lots")
}

// Association Animal-Lot
model LotAnimal {
  id        String   @id @default(uuid())
  farmId    String   @map("farm_id")
  lotId     String   @map("lot_id")
  animalId  String   @map("animal_id")
  joinedAt  DateTime @default(now()) @map("joined_at")
  leftAt    DateTime? @map("left_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  lot Lot @relation(fields: [lotId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@unique([lotId, animalId, joinedAt])
  @@index([farmId])
  @@index([lotId])
  @@index([animalId])
  @@map("lot_animals")
}

// Traitement unifi√© (traitement + vaccination)
model Treatment {
  id                          String           @id @default(uuid())
  farmId                      String           @map("farm_id")
  type                        TreatmentType    @default(treatment)  // treatment | vaccination

  // Animal
  animalId                    String           @map("animal_id")
  animalWeightKg              Float?           @map("animal_weight_kg")  // Snapshot du poids

  // Produit utilis√© (via packaging) - optionnels pour r√©trocompatibilit√©
  packagingId                 String?          @map("packaging_id")
  productId                   String?          @map("product_id")      // Pour requ√™tes rapides
  indicationId                String?          @map("indication_id")   // R√®gle utilis√©e
  routeId                     String?          @map("route_id")

  // Tra√ßabilit√© lot m√©dicament (via FarmerProductLot)
  farmerLotId                 String?          @map("farmer_lot_id")

  // Administration (nouvelle structure)
  treatmentDate               DateTime         @map("treatment_date")
  quantityAdministered        Float?           @map("quantity_administered")  // ml
  quantityUnitId              String?          @map("quantity_unit_id")

  // Anciens champs (r√©trocompatibilit√©) - sera supprim√© apr√®s migration frontend
  productName                 String?          @map("product_name")
  dose                        Float?
  dosage                      Float?
  dosageUnit                  String?          @map("dosage_unit")
  withdrawalEndDate           DateTime?        @map("withdrawal_end_date")

  // Calculs stock√©s (audit)
  computedDoseMgPerKg         Float?           @map("computed_dose_mg_per_kg")
  computedWithdrawalMeatDate  DateTime?        @map("computed_withdrawal_meat_date")
  computedWithdrawalMilkDate  DateTime?        @map("computed_withdrawal_milk_date")

  // Responsable
  veterinarianId              String?          @map("veterinarian_id")
  veterinarianName            String?          @map("veterinarian_name")

  // Sp√©cifique traitement (type = treatment)
  diagnosis                   String?
  duration                    Int?             // jours de traitement

  // Sp√©cifique vaccination (type = vaccination)
  targetDisease               String?          @map("target_disease")
  nextDueDate                 DateTime?        @map("next_due_date")     // Rappel
  vaccinationType             VaccinationType? @map("vaccination_type")  // mandatory, recommended, optional
  protocolStep                Int?             @map("protocol_step")     // 1, 2, 3...

  // Autres
  campaignId                  String?          @map("campaign_id")
  status                      String           @default("completed")
  cost                        Float?
  notes                       String?

  // M√©tadonn√©es
  version                     Int              @default(1)
  deletedAt                   DateTime?        @map("deleted_at")
  createdAt                   DateTime         @default(now()) @map("created_at")
  updatedAt                   DateTime         @updatedAt @map("updated_at")

  // Relations
  farm                        Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  animal                      Animal           @relation(fields: [animalId], references: [id], onDelete: Cascade)
  packaging                   ProductPackaging? @relation(fields: [packagingId], references: [id])
  product                     Product?         @relation(fields: [productId], references: [id])
  indication                  TherapeuticIndication? @relation(fields: [indicationId], references: [id])
  route                       AdministrationRoute? @relation(fields: [routeId], references: [id])
  quantityUnit                Unit?            @relation("QuantityUnit", fields: [quantityUnitId], references: [id])
  veterinarian                Veterinarian?    @relation(fields: [veterinarianId], references: [id])
  farmerLot                   FarmerProductLot? @relation(fields: [farmerLotId], references: [id])

  // Indexes
  @@index([farmId])
  @@index([animalId])
  @@index([packagingId])
  @@index([productId])
  @@index([indicationId])
  @@index([routeId])
  @@index([farmerLotId])
  @@index([type])
  @@index([treatmentDate])
  @@index([deletedAt])
  @@index([farmId, type, deletedAt])
  @@index([animalId, type, deletedAt])
  @@index([computedWithdrawalMeatDate])
  @@index([computedWithdrawalMilkDate])

  @@map("treatments")
}

// Mouvement (entr√©e/sortie)
model Movement {
  id                  String    @id @default(uuid())
  farmId              String    @map("farm_id")
  lotId               String?   @map("lot_id")
  movementType        String    @map("movement_type") // birth, purchase, sale, death, slaughter, temporary_out, temporary_return
  movementDate        DateTime  @map("movement_date")
  reason              String?
  status              String    @default("ongoing") // ongoing, closed, archived

  // Pour les ventes
  buyerName           String?   @map("buyer_name")
  buyerType           String?   @map("buyer_type")
  buyerContact        String?   @map("buyer_contact")
  buyerFarmId         String?   @map("buyer_farm_id")
  buyerQrSignature    String?   @map("buyer_qr_signature")
  salePrice           Float?    @map("sale_price")

  // Pour les achats
  sellerName          String?   @map("seller_name")
  purchasePrice       Float?    @map("purchase_price")

  // Pour les transferts
  destinationFarmId   String?   @map("destination_farm_id")
  originFarmId        String?   @map("origin_farm_id")

  // Pour les abattages
  slaughterhouseName  String?   @map("slaughterhouse_name")
  slaughterhouseId    String?   @map("slaughterhouse_id")

  // Pour les mouvements temporaires
  isTemporary         Boolean   @default(false) @map("is_temporary")
  temporaryType       String?   @map("temporary_type") // loan, transhumance, boarding, quarantine, exhibition
  expectedReturnDate  DateTime? @map("expected_return_date")
  returnDate          DateTime? @map("return_date")
  returnNotes         String?   @map("return_notes")
  relatedMovementId   String?   @map("related_movement_id")

  documentNumber      String?   @map("document_number")
  notes               String?
  version             Int       @default(1)
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  movementAnimals MovementAnimal[]

  @@index([farmId])
  @@index([movementDate])
  @@index([movementType])
  @@index([status])
  @@index([deletedAt])
  @@map("movements")
}

// Association Movement-Animal
model MovementAnimal {
  id         String @id @default(uuid())
  movementId String @map("movement_id")
  animalId   String @map("animal_id")

  movement Movement @relation(fields: [movementId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@unique([movementId, animalId])
  @@map("movement_animals")
}

// Pes√©e
model Weight {
  id          String   @id @default(uuid())
  farmId      String   @map("farm_id")
  animalId    String   @map("animal_id")
  weight      Float    // kg
  weightDate  DateTime @map("weight_date")
  source      String   @default("manual") // manual, scale, estimated
  notes       String?
  version     Int      @default(1)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([animalId])
  @@index([weightDate])
  @@index([deletedAt])
  @@map("weights")
}

// Reproduction
model Breeding {
  id                     String    @id @default(uuid())
  farmId                 String    @map("farm_id")
  motherId               String    @map("mother_id")
  fatherId               String?   @map("father_id")
  fatherName             String?   @map("father_name") // for external males
  method                 String    // natural, artificial_insemination, embryo_transfer
  breedingDate           DateTime  @map("breeding_date")
  expectedBirthDate      DateTime  @map("expected_birth_date")
  actualBirthDate        DateTime? @map("actual_birth_date")
  expectedOffspringCount Int?      @map("expected_offspring_count")
  offspringIds           Json?     @map("offspring_ids") // JSON array
  veterinarianId         String?   @map("veterinarian_id")
  veterinarianName       String?   @map("veterinarian_name")
  status                 String    @default("planned") // planned, in_progress, confirmed, failed, delivered
  notes                  String?
  version                Int       @default(1)
  deletedAt              DateTime? @map("deleted_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  mother Animal @relation("BreedingMother", fields: [motherId], references: [id], onDelete: Cascade)
  father Animal? @relation("BreedingFather", fields: [fatherId], references: [id])

  @@index([farmId])
  @@index([motherId])
  @@index([breedingDate])
  @@index([deletedAt])
  @@map("breedings")
}

// Campagne personnelle (vaccination de masse, traitement collectif, etc.)
model PersonalCampaign {
  id                String                   @id @default(uuid())
  farmId            String                   @map("farm_id")
  lotId             String?                  @map("lot_id")
  name              String
  description       String?
  productId         String                   @map("product_id")  // üÜï FK vers MedicalProduct (Master Table)
  productName       String                   @map("product_name") // Garder pour tra√ßabilit√© historique
  type              CampaignType
  campaignDate      DateTime                 @map("campaign_date")
  withdrawalEndDate DateTime                 @map("withdrawal_end_date")
  veterinarianId    String?                  @map("veterinarian_id")
  veterinarianName  String?                  @map("veterinarian_name")
  animalIdsJson     String                   @map("animal_ids_json") // JSON string of animal IDs
  status            PersonalCampaignStatus   @default(planned)
  startDate         DateTime?                @map("start_date")
  endDate           DateTime?                @map("end_date")
  targetCount       Int?                     @map("target_count")
  completedCount    Int                      @default(0) @map("completed_count")
  completed         Boolean                  @default(false)
  notes             String?
  version           Int                      @default(1)
  deletedAt         DateTime?                @map("deleted_at")
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  lot Lot? @relation(fields: [lotId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@index([farmId])
  @@index([productId])
  @@index([status])
  @@index([startDate])
  @@index([deletedAt])
  @@map("personal_campaigns")
}

// Document
model Document {
  id             String    @id @default(uuid())
  farmId         String    @map("farm_id")
  animalId       String?   @map("animal_id")
  type           String    // health_certificate, movement_permit, passport, invoice, etc.
  title          String?
  fileName       String    @map("file_name")
  fileUrl        String    @map("file_url")
  fileSizeBytes  Int?      @map("file_size_bytes")
  mimeType       String?   @map("mime_type")
  uploadDate     DateTime  @map("upload_date")
  documentNumber String?   @map("document_number")
  issueDate      DateTime? @map("issue_date")
  expiryDate     DateTime? @map("expiry_date")
  uploadedBy     String?   @map("uploaded_by")
  notes          String?
  version        Int       @default(1)
  deletedAt      DateTime? @map("deleted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([animalId])
  @@index([type])
  @@index([deletedAt])
  @@map("documents")
}

// ENUMs pour FarmPreferences (PHASE_15)
enum Language {
  fr
  en
  ar
}

enum WeightUnit {
  kg
  lb
}

enum Currency {
  DZD  // Dinar alg√©rien
  EUR  // Euro
  USD  // Dollar am√©ricain
  MAD  // Dirham marocain
}

// Pr√©f√©rences de la ferme (PHASE_15)
model FarmPreferences {
  id                     String    @id @default(uuid())
  farmId                 String    @unique @map("farm_id")
  defaultVeterinarianId  String?    @map("default_veterinarian_id")
  defaultSpeciesId       String?    @map("default_species_id")
  defaultBreedId         String?    @map("default_breed_id")
  weightUnit             WeightUnit @default(kg) @map("weight_unit")
  currency               Currency   @default(DZD)
  language               Language   @default(fr)
  dateFormat             String     @default("DD/MM/YYYY") @map("date_format")
  enableNotifications    Boolean    @default(true) @map("enable_notifications")
  version                Int       @default(1)
  deletedAt              DateTime? @map("deleted_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("farm_preferences")
}

// Pr√©f√©rences produits de la ferme (+ Configuration personnalis√©e √©leveur)
model FarmProductPreference {
  id           String    @id @default(uuid())
  farmId       String    @map("farm_id")
  productId    String    @map("product_id")

  // Pr√©f√©rences de base
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")

  // Configuration personnalis√©e √©leveur (surcharge AMM/RCP)
  packagingId               String?       @map("packaging_id")
  userDefinedDose           Decimal?      @map("user_defined_dose") @db.Decimal(10, 4)
  userDefinedDoseUnit       DoseUnitType? @map("user_defined_dose_unit")
  userDefinedMeatWithdrawal Int?          @map("user_defined_meat_withdrawal")  // Jours
  userDefinedMilkWithdrawal Int?          @map("user_defined_milk_withdrawal")  // Heures

  version      Int       @default(1)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  farm      Farm              @relation(fields: [farmId], references: [id], onDelete: Cascade)
  product   Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  packaging ProductPackaging? @relation(fields: [packagingId], references: [id])
  lots      FarmerProductLot[]

  @@unique([farmId, productId])
  @@index([farmId])
  @@index([productId])
  @@index([packagingId])
  @@index([farmId, deletedAt])
  @@map("farm_product_preferences")
}

// Lots de m√©dicaments g√©r√©s par l'√©leveur
model FarmerProductLot {
  id                String   @id @default(uuid())
  configId          String   @map("config_id")
  nickname          String                          // "Lot 1", "Flacon Janvier"
  officialLotNumber String   @map("official_lot_number") // "C4567-9A"
  expiryDate        DateTime @map("expiry_date")
  isActive          Boolean  @default(true) @map("is_active")
  version           Int      @default(1)
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  config     FarmProductPreference @relation(fields: [configId], references: [id], onDelete: Cascade)
  treatments Treatment[]

  // Constraints
  @@unique([configId, officialLotNumber])

  // Indexes
  @@index([configId])
  @@index([configId, isActive])
  @@index([expiryDate])
  @@index([deletedAt])
  @@index([configId, isActive, deletedAt])

  @@map("farmer_product_lots")
}

// Pr√©f√©rences v√©t√©rinaires de la ferme (PHASE_23 - BLOC 4)
model FarmVeterinarianPreference {
  id              String    @id @default(uuid())
  farmId          String    @map("farm_id")
  veterinarianId  String    @map("veterinarian_id")
  displayOrder    Int       @default(0) @map("display_order")
  isActive        Boolean   @default(true) @map("is_active")
  isDefault       Boolean   @default(false) @map("is_default")
  version         Int       @default(1)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  farm         Farm         @relation(fields: [farmId], references: [id], onDelete: Cascade)
  veterinarian Veterinarian @relation(fields: [veterinarianId], references: [id], onDelete: Cascade)

  @@unique([farmId, veterinarianId])
  @@index([farmId])
  @@index([veterinarianId])
  @@index([farmId, deletedAt])
  @@index([farmId, isDefault])
  @@map("farm_veterinarian_preferences")
}


// Pr√©f√©rences campagnes nationales de la ferme (PHASE_24 - BLOC 4)
model FarmNationalCampaignPreference {
  id         String    @id @default(uuid())
  farmId     String    @map("farm_id")
  campaignId String    @map("campaign_id")
  isEnrolled Boolean   @default(false) @map("is_enrolled")
  enrolledAt DateTime? @map("enrolled_at")
  version    Int       @default(1)
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  farm     Farm             @relation(fields: [farmId], references: [id], onDelete: Cascade)
  campaign NationalCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([farmId, campaignId])
  @@index([farmId])
  @@index([campaignId])
  @@index([isEnrolled])
  @@index([farmId, deletedAt])
  @@map("farm_national_campaign_preferences")
}

// ============================================================
// SYNCHRONISATION
// ============================================================

// Queue de synchronisation
model SyncQueueItem {
  id              String   @id @default(uuid())
  farmId          String   @map("farm_id")
  entityType      String   @map("entity_type") // animal, treatment, vaccination, etc.
  entityId        String   @map("entity_id")
  action          String   // create, update, delete
  payload         Json     // donn√©es de l'entit√©
  clientTimestamp DateTime @map("client_timestamp")
  serverTimestamp DateTime? @map("server_timestamp")
  status          String   @default("pending") // pending, synced, conflict, failed
  conflictData    Json?    @map("conflict_data") // donn√©es serveur en cas de conflit
  errorMessage    String?  @map("error_message")
  retryCount      Int      @default(0) @map("retry_count")
  createdAt       DateTime @default(now()) @map("created_at")
  processedAt     DateTime? @map("processed_at")

  @@index([farmId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("sync_queue_items")
}

// Log de synchronisation (historique)
model SyncLog {
  id              String   @id @default(uuid())
  farmId          String   @map("farm_id")
  syncType        String   @map("sync_type") // push, pull
  itemsCount      Int      @map("items_count")
  successCount    Int      @map("success_count")
  failureCount    Int      @map("failure_count")
  conflictCount   Int      @map("conflict_count")
  duration        Int      // millisecondes
  deviceInfo      String?  @map("device_info")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([farmId])
  @@index([createdAt])
  @@map("sync_logs")
}
