generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

// ENUM pour les maladies cibl√©es par les vaccins
enum VaccineTargetDisease {
  brucellosis
  bluetongue
  foot_and_mouth
  rabies
  anthrax
  lumpy_skin
  ppr          // Peste Petits Ruminants
  sheep_pox
  enterotoxemia
  pasteurellosis
  other
}

// ENUM pour types de campagnes nationales
enum CampaignType {
  vaccination
  deworming
  screening
  treatment
  census
  other
}

// ============================================================
// TABLES DE R√âF√âRENCE (Backend)
// ============================================================

// Table de r√©f√©rence - Esp√®ces
model Species {
  id          String    @id                 // Existant : "bovine", "ovine", "caprine"
  nameFr      String    @map("name_fr")      // Existant
  nameEn      String    @map("name_en")      // Existant
  nameAr      String    @map("name_ar")      // Existant
  icon        String                         // Existant (gard√© pour compatibilit√©)
  displayOrder Int      @default(0) @map("display_order") // Existant (gard√© pour compatibilit√©)
  description String?                        // Nouveau champ optionnel

  // Nouveaux champs - PHASE_01
  version     Int       @default(1)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  animals Animal[]
  breeds  Breed[]

  // Indexes
  @@index([deletedAt])

  @@map("species")
}

// Table de r√©f√©rence - Races (PHASE_12)
model Breed {
  id           String    @id @default(uuid())
  code         String    @unique              // Code unique (ex: "lacaune", "holstein")
  speciesId    String    @map("species_id")
  nameFr       String    @map("name_fr")
  nameEn       String    @map("name_en")
  nameAr       String    @map("name_ar")
  description  String?
  displayOrder Int       @default(0) @map("display_order")
  isActive     Boolean   @default(true) @map("is_active")
  version      Int       @default(1)
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  species Species  @relation(fields: [speciesId], references: [id])
  animals Animal[]
  breedCountries  BreedCountry[]       // PHASE_16
  farmPreferences FarmBreedPreference[] // PHASE_20

  // Indexes simples
  @@index([speciesId])
  @@index([code])
  @@index([deletedAt])
  @@index([displayOrder])
  @@index([isActive])

  // Index composites (RECOMMANDATIONS - performance)
  @@index([speciesId, isActive, deletedAt])  // Query: races actives d'une esp√®ce
  @@index([speciesId, displayOrder])         // Query: races tri√©es par esp√®ce

  @@map("breeds")
}

// Table de r√©f√©rence - Pays (ISO 3166-1)
model Country {
  code      String   @id           // ISO 3166-1 alpha-2 (ex: "FR", "DZ")
  nameFr    String   @map("name_fr")
  nameEn    String   @map("name_en")
  nameAr    String   @map("name_ar")
  region    String?  // "Europe", "Africa", "Asia", "Americas", "Oceania"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (BLOC 3 - Phases 16-19)
  breedCountries    BreedCountry[]       // PHASE_16
  // productCountries  ProductCountry[]   // PHASE_17
  // vaccineCountries  VaccineCountry[]   // PHASE_18
  campaignCountries CampaignCountry[]    // PHASE_19

  @@index([isActive])
  @@index([region])
  @@map("countries")
}

// Table de liaison - Breeds ‚Üî Countries (PHASE_16)
model BreedCountry {
  id          String    @id @default(uuid())
  breedId     String    @map("breed_id")
  countryCode String    @map("country_code")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  breed   Breed   @relation(fields: [breedId], references: [id], onDelete: Cascade)
  country Country @relation(fields: [countryCode], references: [code], onDelete: Cascade)

  @@unique([breedId, countryCode])
  @@index([breedId])
  @@index([countryCode])
  @@index([isActive])
  @@map("breed_countries")
}

// Table de r√©f√©rence - Campagnes Nationales (PHASE_07)
model NationalCampaign {
  id              String        @id @default(uuid())
  code            String        @unique
  nameFr          String        @map("name_fr")
  nameEn          String        @map("name_en")
  nameAr          String        @map("name_ar")
  description     String?
  type            CampaignType
  startDate       DateTime      @map("start_date")
  endDate         DateTime      @map("end_date")
  isActive        Boolean       @default(true) @map("is_active")
  version         Int           @default(1)
  deletedAt       DateTime?     @map("deleted_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations (BLOC 3 & BLOC 4)
  campaignCountries CampaignCountry[]  // PHASE_19
  // farmPreferences   FarmNationalCampaignPreference[]  // PHASE_24

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([deletedAt])
  @@map("national_campaigns")
}

// Table de liaison - NationalCampaign ‚Üî Countries (PHASE_19)
model CampaignCountry {
  id          String   @id @default(uuid())
  campaignId  String   @map("campaign_id")
  countryCode String   @map("country_code")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  campaign NationalCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  country  Country          @relation(fields: [countryCode], references: [code], onDelete: Cascade)

  @@unique([campaignId, countryCode])
  @@index([campaignId])
  @@index([countryCode])
  @@index([isActive])
  @@map("campaign_countries")
}

// Table de pr√©f√©rences - Farm ‚Üî Breeds (PHASE_20)
model FarmBreedPreference {
  id          String   @id @default(uuid())
  farmId      String   @map("farm_id")
  breedId     String   @map("breed_id")
  displayOrder Int     @default(0) @map("display_order")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  farm  Farm  @relation(fields: [farmId], references: [id], onDelete: Cascade)
  breed Breed @relation(fields: [breedId], references: [id], onDelete: Cascade)

  @@unique([farmId, breedId])
  @@index([farmId])
  @@index([breedId])
  @@index([displayOrder])
  @@map("farm_breed_preferences")
}

// Table de r√©f√©rence - Vaccins globaux (PHASE_06)
model VaccineGlobal {
  id                String               @id @default(uuid())
  code              String               @unique
  nameFr            String               @map("name_fr")
  nameEn            String               @map("name_en")
  nameAr            String               @map("name_ar")
  description       String?
  targetDisease     VaccineTargetDisease @map("target_disease")
  laboratoire       String?
  numeroAMM         String?              @map("numero_amm")
  dosageRecommande  String?              @map("dosage_recommande")
  dureeImmunite     Int?                 @map("duree_immunite")  // En jours
  version           Int                  @default(1)
  deletedAt         DateTime?            @map("deleted_at")
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")

  // Relations (seront ajout√©es dans BLOC 3 & BLOC 4)
  // vaccineCountries  VaccineCountry[]        // PHASE_18
  // farmPreferences   FarmVaccinePreference[] // PHASE_22

  @@index([code])
  @@index([targetDisease])
  @@index([deletedAt])
  @@map("vaccines_global")
}

// V√©t√©rinaires (multi-tenant)
model Veterinarian {
  id                    String    @id @default(uuid())
  farmId                String    @map("farm_id")
  firstName             String    @map("first_name")
  lastName              String    @map("last_name")
  title                 String?
  licenseNumber         String    @map("license_number")
  specialties           String    // comma-separated or JSON string
  clinic                String?
  phone                 String
  mobile                String?
  email                 String?
  address               String?
  city                  String?
  postalCode            String?   @map("postal_code")
  country               String?

  // üÜï PHASE_13: Champs g√©ographiques
  department            String?   // Ex: "81", "2A"
  commune               String?   // Ex: "81004"
  isAvailable           Boolean   @default(true) @map("is_available")
  emergencyService      Boolean   @default(false) @map("emergency_service")
  workingHours          String?   @map("working_hours")
  consultationFee       Float?    @map("consultation_fee")
  emergencyFee          Float?    @map("emergency_fee")
  currency              String?
  notes                 String?
  isPreferred           Boolean   @default(false) @map("is_preferred")
  isDefault             Boolean   @default(false) @map("is_default")
  rating                Int       @default(5)
  totalInterventions    Int       @default(0) @map("total_interventions")
  lastInterventionDate  DateTime? @map("last_intervention_date")
  isActive              Boolean   @default(true) @map("is_active")
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  treatments Treatment[]
  vaccinations Vaccination[]

  @@index([farmId])
  @@index([deletedAt])

  // üÜï PHASE_13: Index simples
  @@index([isActive])
  @@index([isDefault])
  @@index([department])

  // üÜï PHASE_13: Index composites
  @@index([farmId, isActive, deletedAt])   // V√©t√©rinaires actifs d'une ferme
  @@index([department, isActive])          // V√©t√©rinaires par d√©partement
  @@index([farmId, isDefault])             // V√©t√©rinaire par d√©faut

  @@map("veterinarians")
}

// Produits m√©dicaux personnalis√©s (multi-tenant) - PHASE_09
model CustomMedicalProduct {
  id                        String    @id @default(uuid())
  farmId                    String    @map("farm_id")
  name                      String
  commercialName            String?   @map("commercial_name")
  category                  String    // antibiotic, anti-inflammatory, vitamin, etc.
  activeIngredient          String?   @map("active_ingredient")
  manufacturer              String?
  form                      String?   // tablet, injection, powder, etc.
  dosage                    Float?
  dosageUnit                String?   @map("dosage_unit")
  withdrawalPeriodMeat      Int       @map("withdrawal_period_meat") // jours
  withdrawalPeriodMilk      Int       @map("withdrawal_period_milk") // jours
  currentStock              Float     @default(0) @map("current_stock")
  minStock                  Float     @default(0) @map("min_stock")
  stockUnit                 String    @map("stock_unit")
  unitPrice                 Float?    @map("unit_price")
  currency                  String?
  batchNumber               String?   @map("batch_number")
  expiryDate                DateTime? @map("expiry_date")
  storageConditions         String?   @map("storage_conditions")
  prescription              String?   // prescription notes/requirements
  type                      String    @default("treatment") // treatment, vaccine
  targetSpecies             String    @default("") @map("target_species")
  standardCureDays          Int?      @map("standard_cure_days")
  administrationFrequency   String?   @map("administration_frequency")
  dosageFormula             String?   @map("dosage_formula")
  vaccinationProtocol       String?   @map("vaccination_protocol")
  reminderDays              String?   @map("reminder_days") // comma-separated
  defaultAdministrationRoute String?  @map("default_administration_route")
  defaultInjectionSite      String?   @map("default_injection_site")
  notes                     String?
  isActive                  Boolean   @default(true) @map("is_active")
  version                   Int       @default(1)
  deletedAt                 DateTime? @map("deleted_at")
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  treatments Treatment[]

  // Relations (seront ajout√©es dans BLOC 4 - PHASE_21)
  // farmPreferences FarmProductPreference[]

  @@index([farmId])
  @@index([deletedAt])
  @@map("custom_medical_products")
}

// Vaccins personnalis√©s (multi-tenant) - PHASE_10
model CustomVaccine {
  id                String    @id @default(uuid())
  farmId            String    @map("farm_id")
  name              String
  description       String?
  targetDisease     String?   @map("target_disease")
  laboratoire       String?
  dosage            String?
  version           Int       @default(1)
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  farm              Farm      @relation(fields: [farmId], references: [id], onDelete: Cascade)
  // farmPreferences   FarmVaccinePreference[]  // PHASE_22

  @@index([farmId])
  @@index([deletedAt])
  @@map("custom_vaccines")
}

// Table de r√©f√©rence - Voies d'administration
model AdministrationRoute {
  id          String    @id @default(uuid())
  code        String    @unique                // "oral", "injectable", etc.
  nameFr      String    @map("name_fr")
  nameEn      String    @map("name_en")
  nameAr      String    @map("name_ar")
  description String?

  // Nouveaux champs
  version     Int       @default(1)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  treatments  Treatment[]

  // Indexes
  @@index([code])
  @@index([deletedAt])

  @@map("administration_routes")
}

// ============================================================
// TABLES GLOBALES (Catalogue International)
// ============================================================

// Pays (r√©f√©rentiel international ISO 3166-1)
model Country {
  code      String   @id           // ISO 3166-1 alpha-2 (ex: "FR", "DZ")
  nameFr    String   @map("name_fr")
  nameEn    String   @map("name_en")
  nameAr    String   @map("name_ar")
  region    String?  // "Europe", "Africa", "Asia", "Americas", "Oceania"
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations (tables de liaison pays)
  // breedCountries    BreedCountry[]       // Phase 16
  productCountries  ProductCountry[]       // Phase 17
  // vaccineCountries  VaccineCountry[]     // Phase 18
  // campaignCountries CampaignCountry[]    // Phase 19

  @@index([isActive])
  @@index([region])
  @@map("countries")
}

// Produits m√©dicaux (catalogue global)
model GlobalMedicalProduct {
  id            String              @id @default(uuid())
  code          String              @unique               // Code unique (ex: "enrofloxacine_100")
  nameFr        String              @map("name_fr")
  nameEn        String              @map("name_en")
  nameAr        String              @map("name_ar")
  description   String?
  type          MedicalProductType
  principeActif String?             @map("principe_actif")
  laboratoire   String?
  numeroAMM     String?             @map("numero_amm")    // Autorisation Mise sur le March√©
  version       Int                 @default(1)
  deletedAt     DateTime?           @map("deleted_at")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  // Relations (√† impl√©menter dans phases futures)
  productCountries  ProductCountry[]          // Phase 17
  // farmPreferences   FarmProductPreference[]   // Phase 21

  @@index([code])
  @@index([type])
  @@index([laboratoire])
  @@index([deletedAt])
  @@map("global_medical_products")
}

// Table de liaison - Produits m√©dicaux ‚Üî Pays (Phase 17)
model ProductCountry {
  id          String    @id @default(uuid())
  productId   String    @map("product_id")
  countryCode String    @map("country_code")
  numeroAMM   String?   @map("numero_amm")    // AMM sp√©cifique au pays
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  product GlobalMedicalProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  country Country              @relation(fields: [countryCode], references: [code], onDelete: Cascade)

  @@unique([productId, countryCode])
  @@index([productId])
  @@index([countryCode])
  @@map("product_countries")
}

// Templates d'alertes (catalogue global)
model AlertTemplate {
  id              String         @id @default(uuid())
  code            String         @unique
  nameFr          String         @map("name_fr")
  nameEn          String         @map("name_en")
  nameAr          String         @map("name_ar")
  descriptionFr   String?        @map("description_fr")
  descriptionEn   String?        @map("description_en")
  descriptionAr   String?        @map("description_ar")
  category        AlertCategory
  priority        AlertPriority  @default(medium)
  isActive        Boolean        @default(true) @map("is_active")
  version         Int            @default(1)
  deletedAt       DateTime?      @map("deleted_at")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@index([code])
  @@index([category])
  @@index([priority])
  @@index([isActive])
  @@index([deletedAt])
  @@map("alert_templates")
}

// ============================================================
// TABLES DE R√âF√âRENCE (Configuration)
// ============================================================

// Table de r√©f√©rence - Configuration des alertes
model AlertConfiguration {
  id                      String    @id @default(uuid())
  farmId                  String    @unique @map("farm_id")
  enableEmailAlerts       Boolean   @default(true) @map("enable_email_alerts")
  enableSmsAlerts         Boolean   @default(false) @map("enable_sms_alerts")
  enablePushAlerts        Boolean   @default(true) @map("enable_push_alerts")
  vaccinationReminderDays Int       @default(7) @map("vaccination_reminder_days")
  treatmentReminderDays   Int       @default(3) @map("treatment_reminder_days")
  healthCheckReminderDays Int       @default(30) @map("health_check_reminder_days")
  version                 Int       @default(1)
  deletedAt               DateTime? @map("deleted_at")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("alert_configurations")
}

// ENUM pour types de campagnes nationales
enum CampaignType {
  vaccination
  deworming
  screening
  treatment
  census
  other
}

// Table de r√©f√©rence - Campagnes Nationales (globale)
model NationalCampaign {
  id              String        @id @default(uuid())
  code            String        @unique
  nameFr          String        @map("name_fr")
  nameEn          String        @map("name_en")
  nameAr          String        @map("name_ar")
  description     String?
  type            CampaignType
  startDate       DateTime      @map("start_date")
  endDate         DateTime      @map("end_date")
  isActive        Boolean       @default(true) @map("is_active")
  version         Int           @default(1)
  deletedAt       DateTime?     @map("deleted_at")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relations (√† compl√©ter dans phases futures)
  // campaignCountries CampaignCountry[]  // PHASE_19
  // farmPreferences   FarmNationalCampaignPreference[]  // PHASE_24

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([deletedAt])
  @@map("national_campaigns")
}

// ============================================================
// TABLES PRINCIPALES
// ============================================================

// Ferme
model Farm {
  id            String    @id
  ownerId       String    @map("owner_id")
  groupId       String?   @map("group_id")
  name          String
  address       String?
  postalCode    String?   @map("postal_code")
  city          String?

  // Champs g√©ographiques
  country       String?   // Code ISO 3166-1 alpha-2 (ex: "FR", "DZ")
  department    String?   // Code d√©partement (ex: "81", "2A")
  commune       String?   // Code INSEE commune (ex: "81004")

  latitude      Float?
  longitude     Float?

  // Champs existants (compatibilit√©)
  location      String
  cheptelNumber String?   @map("cheptel_number")
  groupName     String?   @map("group_name")

  isDefault     Boolean   @default(false) @map("is_default")

  // Activation/d√©sactivation
  isActive      Boolean   @default(true) @map("is_active")

  // Soft delete, versioning, timestamps
  version       Int       @default(1)
  deletedAt     DateTime? @map("deleted_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  animals Animal[]
  lots Lot[]
  movements Movement[]
  personalCampaigns PersonalCampaign[]
  documents Document[]
  weights Weight[]
  treatments Treatment[]
  vaccinations Vaccination[]
  breedings Breeding[]
  lotAnimals LotAnimal[]
  veterinarians Veterinarian[]
  medicalProducts MedicalProduct[]
  customVaccines CustomVaccine[]
  preferences FarmPreferences?
  alertConfigurations AlertConfiguration[]
  breedPreferences FarmBreedPreference[] // PHASE_20

  // Indexes
  @@index([ownerId])
  @@index([groupId])
  @@index([isDefault])
  @@index([isActive])
  @@index([deletedAt])
  @@index([country])
  @@index([department])

  // Index composites (RECOMMENDATIONS)
  @@index([ownerId, isActive, deletedAt])
  @@index([country, department])
  @@index([ownerId, isDefault])

  @@map("farms")
}

// Animal
model Animal {
  id                    String    @id
  farmId                String    @map("farm_id")
  currentLocationFarmId String?   @map("current_location_farm_id")
  currentEid            String?   @map("current_eid")
  officialNumber        String?   @map("official_number")
  visualId              String?   @map("visual_id")
  eidHistory            String?   @map("eid_history")
  birthDate             DateTime  @map("birth_date")
  sex                   String
  motherId              String?   @map("mother_id")
  fatherId              String?   @map("father_id")
  speciesId             String?   @map("species_id")
  breedId               String?   @map("breed_id")
  status                String    @default("alive")
  validatedAt           DateTime? @map("validated_at")
  photoUrl              String?   @map("photo_url")
  notes                 String?
  days                  Int?
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  farm     Farm     @relation(fields: [farmId], references: [id], onDelete: Cascade)
  species  Species? @relation(fields: [speciesId], references: [id])
  breed    Breed?   @relation(fields: [breedId], references: [id])
  mother   Animal?  @relation("Parentage", fields: [motherId], references: [id])
  children Animal[] @relation("Parentage")

  lotAnimals LotAnimal[]
  treatments Treatment[]
  vaccinations Vaccination[]
  weights Weight[]
  breedingsAsMother Breeding[] @relation("BreedingMother")
  breedingsAsFather Breeding[] @relation("BreedingFather")
  movementAnimals MovementAnimal[]

  @@unique([farmId, currentEid])
  @@unique([farmId, officialNumber])
  @@index([farmId])
  @@index([status])
  @@index([deletedAt])
  @@map("animals")
}

// ============================================================
// TABLES APP (Donn√©es utilisateur)
// ============================================================

// Lot (groupe d'animaux)
model Lot {
  id                String    @id @default(uuid())
  farmId            String    @map("farm_id")
  name              String
  type              String?   // treatment, sale, slaughter, purchase
  status            String    @default("open") // open, closed, archived
  description       String?
  completed         Boolean   @default(false)
  completedAt       DateTime? @map("completed_at")
  productId         String?   @map("product_id")
  productName       String?   @map("product_name")
  treatmentDate     DateTime? @map("treatment_date")
  withdrawalEndDate DateTime? @map("withdrawal_end_date")
  veterinarianId    String?   @map("veterinarian_id")
  veterinarianName  String?   @map("veterinarian_name")
  priceTotal        Float?    @map("price_total")
  buyerName         String?   @map("buyer_name")
  sellerName        String?   @map("seller_name")
  notes             String?
  isActive          Boolean   @default(true) @map("is_active")
  version           Int       @default(1)
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  lotAnimals LotAnimal[]
  personalCampaigns PersonalCampaign[]

  @@index([farmId])
  @@index([deletedAt])
  @@map("lots")
}

// Association Animal-Lot
model LotAnimal {
  id        String   @id @default(uuid())
  farmId    String   @map("farm_id")
  lotId     String   @map("lot_id")
  animalId  String   @map("animal_id")
  joinedAt  DateTime @default(now()) @map("joined_at")
  leftAt    DateTime? @map("left_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  lot Lot @relation(fields: [lotId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@unique([lotId, animalId, joinedAt])
  @@index([farmId])
  @@index([lotId])
  @@index([animalId])
  @@map("lot_animals")
}

// Traitement m√©dical
model Treatment {
  id                  String   @id @default(uuid())
  farmId              String   @map("farm_id")
  animalId            String   @map("animal_id")
  productId           String   @map("product_id")
  productName         String   @map("product_name")
  veterinarianId      String?  @map("veterinarian_id")
  veterinarianName    String?  @map("veterinarian_name")
  campaignId          String?  @map("campaign_id")
  routeId             String?  @map("route_id")
  diagnosis           String?
  treatmentDate       DateTime @map("treatment_date")
  dose                Float
  dosage              Float?
  dosageUnit          String?  @map("dosage_unit")
  duration            Int?     // jours
  status              String   @default("completed")
  withdrawalEndDate   DateTime @map("withdrawal_end_date")
  cost                Float?
  notes               String?
  version             Int      @default(1)
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)
  product CustomMedicalProduct? @relation(fields: [productId], references: [id])
  veterinarian Veterinarian? @relation(fields: [veterinarianId], references: [id])
  route AdministrationRoute? @relation(fields: [routeId], references: [id])

  @@index([farmId])
  @@index([animalId])
  @@index([treatmentDate])
  @@index([deletedAt])
  @@map("treatments")
}

// Vaccination
model Vaccination {
  id                    String    @id @default(uuid())
  farmId                String    @map("farm_id")
  animalId              String?   @map("animal_id") // nullable for group vaccinations
  animalIds             String    @map("animal_ids") // comma-separated or JSON string
  protocolId            String?   @map("protocol_id")
  vaccineName           String    @map("vaccine_name")
  type                  String    // obligatoire, recommandee, optionnelle
  disease               String
  vaccinationDate       DateTime  @map("vaccination_date")
  batchNumber           String?   @map("batch_number")
  expiryDate            DateTime? @map("expiry_date")
  dose                  String
  administrationRoute   String    @map("administration_route")
  nextDueDate           DateTime? @map("next_due_date")
  veterinarianId        String?   @map("veterinarian_id")
  veterinarianName      String?   @map("veterinarian_name")
  withdrawalPeriodDays  Int       @map("withdrawal_period_days")
  dosage                Float?
  cost                  Float?
  notes                 String?
  version               Int       @default(1)
  deletedAt             DateTime? @map("deleted_at")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  animal Animal? @relation(fields: [animalId], references: [id], onDelete: Cascade)
  veterinarian Veterinarian? @relation(fields: [veterinarianId], references: [id])

  @@index([farmId])
  @@index([animalId])
  @@index([vaccinationDate])
  @@index([deletedAt])
  @@map("vaccinations")
}

// Mouvement (entr√©e/sortie)
model Movement {
  id                  String    @id @default(uuid())
  farmId              String    @map("farm_id")
  lotId               String?   @map("lot_id")
  movementType        String    @map("movement_type") // birth, purchase, sale, death, slaughter, temporary_out, temporary_return
  movementDate        DateTime  @map("movement_date")
  reason              String?
  status              String    @default("ongoing") // ongoing, closed, archived

  // Pour les ventes
  buyerName           String?   @map("buyer_name")
  buyerType           String?   @map("buyer_type")
  buyerContact        String?   @map("buyer_contact")
  buyerFarmId         String?   @map("buyer_farm_id")
  buyerQrSignature    String?   @map("buyer_qr_signature")
  salePrice           Float?    @map("sale_price")

  // Pour les achats
  sellerName          String?   @map("seller_name")
  purchasePrice       Float?    @map("purchase_price")

  // Pour les transferts
  destinationFarmId   String?   @map("destination_farm_id")
  originFarmId        String?   @map("origin_farm_id")

  // Pour les abattages
  slaughterhouseName  String?   @map("slaughterhouse_name")
  slaughterhouseId    String?   @map("slaughterhouse_id")

  // Pour les mouvements temporaires
  isTemporary         Boolean   @default(false) @map("is_temporary")
  temporaryType       String?   @map("temporary_type") // loan, transhumance, boarding, quarantine, exhibition
  expectedReturnDate  DateTime? @map("expected_return_date")
  returnDate          DateTime? @map("return_date")
  returnNotes         String?   @map("return_notes")
  relatedMovementId   String?   @map("related_movement_id")

  documentNumber      String?   @map("document_number")
  notes               String?
  version             Int       @default(1)
  deletedAt           DateTime? @map("deleted_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  movementAnimals MovementAnimal[]

  @@index([farmId])
  @@index([movementDate])
  @@index([movementType])
  @@index([status])
  @@index([deletedAt])
  @@map("movements")
}

// Association Movement-Animal
model MovementAnimal {
  id         String @id @default(uuid())
  movementId String @map("movement_id")
  animalId   String @map("animal_id")

  movement Movement @relation(fields: [movementId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@unique([movementId, animalId])
  @@map("movement_animals")
}

// Pes√©e
model Weight {
  id          String   @id @default(uuid())
  farmId      String   @map("farm_id")
  animalId    String   @map("animal_id")
  weight      Float    // kg
  weightDate  DateTime @map("weight_date")
  source      String   @default("manual") // manual, scale, estimated
  notes       String?
  version     Int      @default(1)
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  animal Animal @relation(fields: [animalId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([animalId])
  @@index([weightDate])
  @@index([deletedAt])
  @@map("weights")
}

// Reproduction
model Breeding {
  id                     String    @id @default(uuid())
  farmId                 String    @map("farm_id")
  motherId               String    @map("mother_id")
  fatherId               String?   @map("father_id")
  fatherName             String?   @map("father_name") // for external males
  method                 String    // natural, artificial_insemination, embryo_transfer
  breedingDate           DateTime  @map("breeding_date")
  expectedBirthDate      DateTime  @map("expected_birth_date")
  actualBirthDate        DateTime? @map("actual_birth_date")
  expectedOffspringCount Int?      @map("expected_offspring_count")
  offspringIds           Json?     @map("offspring_ids") // JSON array
  veterinarianId         String?   @map("veterinarian_id")
  veterinarianName       String?   @map("veterinarian_name")
  status                 String    @default("planned") // planned, in_progress, confirmed, failed, delivered
  notes                  String?
  version                Int       @default(1)
  deletedAt              DateTime? @map("deleted_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  mother Animal @relation("BreedingMother", fields: [motherId], references: [id], onDelete: Cascade)
  father Animal? @relation("BreedingFather", fields: [fatherId], references: [id])

  @@index([farmId])
  @@index([motherId])
  @@index([breedingDate])
  @@index([deletedAt])
  @@map("breedings")
}

// Campagne personnelle (vaccination de masse, traitement collectif, etc.)
model PersonalCampaign {
  id                String                   @id @default(uuid())
  farmId            String                   @map("farm_id")
  lotId             String?                  @map("lot_id")
  name              String
  description       String?
  productId         String                   @map("product_id")
  productName       String                   @map("product_name")
  type              CampaignType
  campaignDate      DateTime                 @map("campaign_date")
  withdrawalEndDate DateTime                 @map("withdrawal_end_date")
  veterinarianId    String?                  @map("veterinarian_id")
  veterinarianName  String?                  @map("veterinarian_name")
  animalIdsJson     String                   @map("animal_ids_json") // JSON string of animal IDs
  status            PersonalCampaignStatus   @default(planned)
  startDate         DateTime?                @map("start_date")
  endDate           DateTime?                @map("end_date")
  targetCount       Int?                     @map("target_count")
  completedCount    Int                      @default(0) @map("completed_count")
  completed         Boolean                  @default(false)
  notes             String?
  version           Int                      @default(1)
  deletedAt         DateTime?                @map("deleted_at")
  createdAt         DateTime                 @default(now()) @map("created_at")
  updatedAt         DateTime                 @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)
  lot Lot? @relation(fields: [lotId], references: [id])

  @@index([farmId])
  @@index([status])
  @@index([startDate])
  @@index([deletedAt])
  @@map("personal_campaigns")
}

// Document
model Document {
  id             String    @id @default(uuid())
  farmId         String    @map("farm_id")
  animalId       String?   @map("animal_id")
  type           String    // health_certificate, movement_permit, passport, invoice, etc.
  title          String?
  fileName       String    @map("file_name")
  fileUrl        String    @map("file_url")
  fileSizeBytes  Int?      @map("file_size_bytes")
  mimeType       String?   @map("mime_type")
  uploadDate     DateTime  @map("upload_date")
  documentNumber String?   @map("document_number")
  issueDate      DateTime? @map("issue_date")
  expiryDate     DateTime? @map("expiry_date")
  uploadedBy     String?   @map("uploaded_by")
  notes          String?
  version        Int       @default(1)
  deletedAt      DateTime? @map("deleted_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([farmId])
  @@index([animalId])
  @@index([type])
  @@index([deletedAt])
  @@map("documents")
}

// ENUMs pour FarmPreferences (PHASE_15)
enum Language {
  fr
  en
  ar
}

enum WeightUnit {
  kg
  lb
}

enum Currency {
  DZD  // Dinar alg√©rien
  EUR  // Euro
  USD  // Dollar am√©ricain
  MAD  // Dirham marocain
}

// Pr√©f√©rences de la ferme (PHASE_15)
model FarmPreferences {
  id                     String    @id @default(uuid())
  farmId                 String    @unique @map("farm_id")
  defaultVeterinarianId  String?    @map("default_veterinarian_id")
  defaultSpeciesId       String?    @map("default_species_id")
  defaultBreedId         String?    @map("default_breed_id")
  weightUnit             WeightUnit @default(kg) @map("weight_unit")
  currency               Currency   @default(DZD)
  language               Language   @default(fr)
  dateFormat             String     @default("DD/MM/YYYY") @map("date_format")
  enableNotifications    Boolean    @default(true) @map("enable_notifications")
  version                Int       @default(1)
  deletedAt              DateTime? @map("deleted_at")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  farm Farm @relation(fields: [farmId], references: [id], onDelete: Cascade)

  @@index([deletedAt])
  @@map("farm_preferences")
}

// ============================================================
// SYNCHRONISATION
// ============================================================

// Queue de synchronisation
model SyncQueueItem {
  id              String   @id @default(uuid())
  farmId          String   @map("farm_id")
  entityType      String   @map("entity_type") // animal, treatment, vaccination, etc.
  entityId        String   @map("entity_id")
  action          String   // create, update, delete
  payload         Json     // donn√©es de l'entit√©
  clientTimestamp DateTime @map("client_timestamp")
  serverTimestamp DateTime? @map("server_timestamp")
  status          String   @default("pending") // pending, synced, conflict, failed
  conflictData    Json?    @map("conflict_data") // donn√©es serveur en cas de conflit
  errorMessage    String?  @map("error_message")
  retryCount      Int      @default(0) @map("retry_count")
  createdAt       DateTime @default(now()) @map("created_at")
  processedAt     DateTime? @map("processed_at")

  @@index([farmId])
  @@index([status])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("sync_queue_items")
}

// Log de synchronisation (historique)
model SyncLog {
  id              String   @id @default(uuid())
  farmId          String   @map("farm_id")
  syncType        String   @map("sync_type") // push, pull
  itemsCount      Int      @map("items_count")
  successCount    Int      @map("success_count")
  failureCount    Int      @map("failure_count")
  conflictCount   Int      @map("conflict_count")
  duration        Int      // millisecondes
  deviceInfo      String?  @map("device_info")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([farmId])
  @@index([createdAt])
  @@map("sync_logs")
}
