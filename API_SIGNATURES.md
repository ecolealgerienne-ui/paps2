# API Signatures - Livestock Management System

**Version:** 1.0
**Last Updated:** 2025-11-20
**Purpose:** Complete API specifications for backend implementation and testing with real payload structures from Flutter app

---

## Table of Contents

1. [Overview & Architecture](#1-overview--architecture)
2. [Generic Field Handling Rules](#2-generic-field-handling-rules)
3. [Authentication (Keycloak)](#3-authentication-keycloak)
4. [SYNC Endpoint](#4-sync-endpoint)
5. [Reference Data Endpoints](#5-reference-data-endpoints)
6. [Health Check](#6-health-check)

---

## 1. Overview & Architecture

### System Architecture

The API consists of two main systems:

**System 1: SYNC (Bidirectional)**
- **Endpoint:** `POST /api/sync`
- **Purpose:** Synchronize transactional data between mobile app and backend
- **Routing:** Single endpoint with `entityType` field to route to appropriate service
- **Entities:** 8 transactional entities (animal, treatment, vaccination, movement, lot, weight, breeding, document)

**System 2: Reference Data (GET-only)**
- **Endpoints:** Multiple GET endpoints (one per entity type)
- **Purpose:** Load reference/configuration data into mobile app
- **Entities:** 9 reference entities (species, breeds, medical_products, vaccines, veterinarians, campaigns, farm_preferences, alert_configurations, farms)

### Technology Stack

- **Backend:** NestJS + TypeScript + Prisma ORM
- **Authentication:** Keycloak (OAuth2/OpenID Connect)
- **Mobile:** Flutter/Dart (offline-first architecture)
- **Data Format:** JSON with mixed naming conventions (see entity-specific sections)

### Base URL

```
Production: https://api.livestock-management.com
Staging: https://api-staging.livestock-management.com
```

---

## 2. Generic Field Handling Rules

### ‚ö†Ô∏è CRITICAL: Backend Field Processing Rules

These rules apply to **ALL 8 SYNC entities** (animal, treatment, vaccination, movement, lot, weight, breeding, document):

#### Fields Backend MUST Take from Payload

The backend **MUST use all fields received in the payload**, respecting client data. This is critical for offline-first scenarios where records are created/modified on the device before sync.

**CRITICAL FIELDS TO PRESERVE:**
- ‚úÖ `created_at` / `createdAt`: Timestamp when record was created on device (offline scenario)
- ‚úÖ `updated_at` / `updatedAt`: Timestamp when record was last modified on device
- ‚úÖ All business fields (entity-specific data)

#### Fields Backend MUST Generate (Server-Side)

The backend **MUST generate** these fields regardless of payload values:

| Field | Rule | CREATE | UPDATE |
|-------|------|--------|--------|
| `server_version` | Auto-increment version number | Initialize to `1` | Increment by `1` |
| `last_synced_at` | Current server timestamp | `DateTime.now()` | `DateTime.now()` |

#### Fields Backend SHOULD Ignore

The backend **SHOULD ignore** these fields from the payload:

- ‚ùå `synced`: This field is meaningless on the server (always true once received)

#### Example: Timestamp Preservation

**Offline Scenario:**
1. User creates animal on device at `2025-01-15T08:00:00Z` (offline)
2. User modifies animal on device at `2025-01-16T10:30:00Z` (offline)
3. Sync occurs at `2025-01-17T14:00:00Z` (online)

**Expected Backend Behavior:**
```javascript
// Backend DTO should receive and preserve:
{
  created_at: "2025-01-15T08:00:00Z",  // ‚úÖ From payload (offline creation time)
  updated_at: "2025-01-16T10:30:00Z",  // ‚úÖ From payload (offline modification time)

  // Backend generates:
  server_version: 1,                    // ‚úÖ Generated by backend
  last_synced_at: "2025-01-17T14:00:00Z" // ‚úÖ Generated by backend (sync time)
}
```

**‚ùå WRONG Implementation:**
```javascript
// DON'T DO THIS - loses offline timestamps
{
  created_at: DateTime.now(),  // ‚ùå WRONG: Overwrites client timestamp
  updated_at: DateTime.now(),  // ‚ùå WRONG: Loses offline modification date
}
```

### Version Conflict Detection

The `server_version` field is used for conflict detection:

- **Client sends:** `server_version` from last successful sync (or `null` for new records)
- **Backend checks:** If client version doesn't match current server version ‚Üí conflict
- **Backend responds:** HTTP 409 Conflict with current server state
- **Client handles:** Conflict resolution (merge, overwrite, or ask user)

---

## 3. Authentication (Keycloak)

### Base URL
```
https://auth.livestock-management.com/realms/livestock
```

### 3.1 Login

**Endpoint:** `POST /protocol/openid-connect/token`

**Request Headers:**
```
Content-Type: application/x-www-form-urlencoded
```

**Request Body (Form Data):**
```
grant_type=password
client_id=livestock-mobile-app
username={username}
password={password}
scope=openid profile email
```

**Response (200 OK):**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_expires_in": 86400,
  "scope": "openid profile email"
}
```

### 3.2 Refresh Token

**Endpoint:** `POST /protocol/openid-connect/token`

**Request Body (Form Data):**
```
grant_type=refresh_token
client_id=livestock-mobile-app
refresh_token={refresh_token}
```

**Response:** Same as login

### 3.3 Logout

**Endpoint:** `POST /protocol/openid-connect/logout`

**Request Body (Form Data):**
```
client_id=livestock-mobile-app
refresh_token={refresh_token}
```

**Response (204 No Content)**

### Authorization Header

All API requests (except auth endpoints) require:
```
Authorization: Bearer {access_token}
```

---

## 4. SYNC Endpoint

### 4.1 SYNC Request Structure

**Endpoint:** `POST /api/sync`

**Headers:**
```
Authorization: Bearer {access_token}
Content-Type: application/json
```

**Request Body:**
```json
{
  "farmId": "string (UUID)",
  "entityType": "animal | treatment | vaccination | movement | lot | weight | breeding | document",
  "entityId": "string (UUID)",
  "action": "create | update | delete",
  "payload": { /* Entity-specific structure - see sections below */ },
  "clientTimestamp": "ISO 8601 datetime string",
  "serverVersion": "string (optional, null for create)"
}
```

**Field Descriptions:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `farmId` | string (UUID) | Yes | Farm identifier (multi-tenancy) |
| `entityType` | enum | Yes | Type of entity being synced |
| `entityId` | string (UUID) | Yes | Unique identifier of the entity |
| `action` | enum | Yes | Operation: `create`, `update`, or `delete` |
| `payload` | object | Yes | Entity data (structure varies by `entityType`) |
| `clientTimestamp` | string | Yes | ISO 8601 timestamp when sync was initiated on client |
| `serverVersion` | string | No | Version from last sync (null for new records) |

**Response (200 OK):**
```json
{
  "success": true,
  "entityType": "animal",
  "entityId": "uuid",
  "serverVersion": "2",
  "lastSyncedAt": "2025-11-20T10:30:00Z",
  "conflicts": []
}
```

**Response (409 Conflict):**
```json
{
  "success": false,
  "error": "version_conflict",
  "message": "Server version mismatch",
  "clientVersion": "1",
  "serverVersion": "3",
  "serverData": { /* Current server state */ }
}
```

**Response (422 Unprocessable Entity):**
```json
{
  "success": false,
  "error": "validation_error",
  "message": "Invalid payload data",
  "validationErrors": [
    {
      "field": "birth_date",
      "message": "Birth date cannot be in the future"
    }
  ]
}
```

---

### 4.2 Entity Type: `animal`

**Naming Convention:** `snake_case` in JSON

**Payload Structure:**
```json
{
  "id": "uuid",
  "farmId": "uuid",
  "current_location_farm_id": "uuid | null",
  "current_eid": "string | null",
  "eid_history": [
    {
      "id": "uuid",
      "oldEid": "string",
      "newEid": "string",
      "changedAt": "ISO 8601 datetime",
      "reason": "string",
      "notes": "string | null"
    }
  ],
  "official_number": "string | null",
  "birth_date": "ISO 8601 datetime",
  "sex": "male | female",
  "mother_id": "uuid | null",
  "status": "draft | alive | sold | dead | slaughtered | onTemporaryMovement",
  "validated_at": "ISO 8601 datetime | null",
  "species_id": "string | null",
  "breed_id": "string | null",
  "visual_id": "string | null",
  "photo_url": "string | null",
  "notes": "string | null",
  "days": "integer | null",
  "synced": "boolean",
  "created_at": "ISO 8601 datetime",
  "updated_at": "ISO 8601 datetime",
  "last_synced_at": "ISO 8601 datetime | null",
  "server_version": "string | null"
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `sex` | `male`, `female` |
| `status` | `draft`, `alive`, `sold`, `dead`, `slaughtered`, `onTemporaryMovement` |

**Important Constraints:**
- `id`: UUID, immutable
- `farmId`: UUID, required
- `birth_date`: Cannot be in the future
- `current_eid`: Optional, can be null if animal has no RFID chip
- `eid_history`: Array of EID changes, can be empty
- `validated_at`: NULL = DRAFT status, NOT NULL = validated animal
- `status`: Controls what operations are allowed on the animal

---

### 4.3 Entity Type: `treatment`

**Naming Convention:** `snake_case` in JSON

**Payload Structure:**
```json
{
  "id": "uuid",
  "farm_id": "uuid",
  "animal_id": "uuid",
  "product_id": "uuid",
  "product_name": "string",
  "dose": "number (double)",
  "treatment_date": "ISO 8601 datetime",
  "withdrawal_end_date": "ISO 8601 datetime",
  "notes": "string | null",
  "veterinarian_id": "uuid | null",
  "veterinarian_name": "string | null",
  "campaign_id": "uuid | null",
  "synced": "boolean",
  "created_at": "ISO 8601 datetime",
  "updated_at": "ISO 8601 datetime",
  "last_synced_at": "ISO 8601 datetime | null",
  "server_version": "string | null"
}
```

**Important Constraints:**
- `animal_id`: Must reference existing animal
- `product_id`: Must reference existing medical product
- `dose`: Positive number
- `withdrawal_end_date`: Must be >= `treatment_date`
- Used for withdrawal period tracking (meat/milk safety)

---

### 4.4 Entity Type: `vaccination`

**Naming Convention:** `snake_case` in JSON

**Payload Structure:**
```json
{
  "id": "uuid",
  "farm_id": "uuid",
  "animal_id": "uuid | null",
  "animal_ids": ["uuid"],
  "protocol_id": "uuid | null",
  "vaccine_name": "string",
  "type": "obligatoire | recommandee | optionnelle",
  "disease": "string",
  "vaccination_date": "ISO 8601 datetime",
  "batch_number": "string | null",
  "expiry_date": "ISO 8601 datetime | null",
  "dose": "string",
  "administration_route": "string",
  "veterinarian_id": "uuid | null",
  "veterinarian_name": "string | null",
  "next_due_date": "ISO 8601 datetime | null",
  "withdrawal_period_days": "integer",
  "notes": "string | null",
  "synced": "boolean",
  "created_at": "ISO 8601 datetime",
  "updated_at": "ISO 8601 datetime",
  "last_synced_at": "ISO 8601 datetime | null",
  "server_version": "string | null"
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `type` | `obligatoire`, `recommandee`, `optionnelle` |

**Important Constraints:**
- Either `animal_id` (single) OR `animal_ids` (group) must be provided, not both
- If `animal_id` is provided, `animal_ids` must be empty
- If `animal_ids` is provided, `animal_id` must be null
- `vaccination_date`: Cannot be in the future
- `expiry_date`: Vaccine batch expiry date (optional)

---

### 4.5 Entity Type: `movement`

**Naming Convention:** `snake_case` in JSON

**Payload Structure:**
```json
{
  "id": "uuid",
  "farm_id": "uuid",
  "animal_id": "uuid",
  "lot_id": "uuid | null",
  "type": "birth | purchase | sale | death | slaughter | temporaryOut | temporaryReturn",
  "movement_date": "ISO 8601 datetime",
  "from_farm_id": "uuid | null",
  "to_farm_id": "uuid | null",
  "price": "number (double) | null",
  "notes": "string | null",
  "buyer_qr_signature": "string | null",
  "buyer_name": "string | null",
  "buyer_farm_id": "uuid | null",
  "buyer_type": "individual | farm | trader | cooperative | null",
  "slaughterhouse_name": "string | null",
  "slaughterhouse_id": "uuid | null",
  "is_temporary": "boolean",
  "temporary_movement_type": "loan | transhumance | boarding | null",
  "expected_return_date": "ISO 8601 datetime | null",
  "return_date": "ISO 8601 datetime | null",
  "return_notes": "string | null",
  "related_movement_id": "uuid | null",
  "status": "ongoing | closed | archived",
  "synced": "boolean",
  "created_at": "ISO 8601 datetime",
  "updated_at": "ISO 8601 datetime",
  "last_synced_at": "ISO 8601 datetime | null",
  "server_version": "string | null"
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `type` | `birth`, `purchase`, `sale`, `death`, `slaughter`, `temporaryOut`, `temporaryReturn` |
| `buyer_type` | `individual`, `farm`, `trader`, `cooperative` |
| `temporary_movement_type` | `loan`, `transhumance`, `boarding` |
| `status` | `ongoing`, `closed`, `archived` |

**Important Constraints:**
- `type`: Determines default `status` value
- `is_temporary`: If true, requires `temporary_movement_type` and `expected_return_date`
- `related_movement_id`: Links temporaryOut ‚Üî temporaryReturn movements
- `buyer_qr_signature`: QR code signature from buyer (if applicable)

---

### 4.6 Entity Type: `lot`

**Naming Convention:** `camelCase` in JSON ‚ö†Ô∏è **(Inconsistent with other entities)**

**Payload Structure:**
```json
{
  "id": "uuid",
  "farmId": "uuid",
  "name": "string",
  "type": "treatment | purchase | sale | slaughter | null",
  "status": "open | closed | archived | null",
  "completed": "boolean",
  "completedAt": "ISO 8601 datetime | null",
  "animalIds": ["uuid"],
  "productId": "uuid | null",
  "productName": "string | null",
  "treatmentDate": "ISO 8601 datetime | null",
  "withdrawalEndDate": "ISO 8601 datetime | null",
  "veterinarianId": "uuid | null",
  "veterinarianName": "string | null",
  "priceTotal": "number (double) | null",
  "buyerName": "string | null",
  "sellerName": "string | null",
  "notes": "string | null",
  "synced": "boolean",
  "createdAt": "ISO 8601 datetime",
  "updatedAt": "ISO 8601 datetime",
  "lastSyncedAt": "ISO 8601 datetime | null",
  "serverVersion": "string | null"
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `type` | `treatment`, `purchase`, `sale`, `slaughter` |
| `status` | `open`, `closed`, `archived` |

**Important Constraints:**
- `type`: Can be null initially, must be set when lot is finalized
- `animalIds`: Array of animal UUIDs in the lot
- `completed`: Legacy field, use `status` for new implementations
- Treatment-specific fields: `productId`, `productName`, `treatmentDate`, `withdrawalEndDate`, `veterinarianId`, `veterinarianName`
- Sale/Purchase-specific fields: `priceTotal`, `buyerName`, `sellerName`

---

### 4.7 Entity Type: `weight`

**Naming Convention:** `snake_case` in JSON

**Payload Structure:**
```json
{
  "id": "uuid",
  "farm_id": "uuid",
  "animal_id": "uuid",
  "weight": "number (double)",
  "recorded_at": "ISO 8601 datetime",
  "source": "scale | manual | estimated | veterinary",
  "notes": "string | null",
  "synced": "boolean",
  "created_at": "ISO 8601 datetime",
  "updated_at": "ISO 8601 datetime",
  "last_synced_at": "ISO 8601 datetime | null",
  "server_version": "string | null"
}
```

**Enums:**

| Enum | Values | Reliability |
|------|--------|-------------|
| `source` | `scale` | 1.0 (100%) |
| | `veterinary` | 0.95 (95%) |
| | `manual` | 0.8 (80%) |
| | `estimated` | 0.6 (60%) |

**Important Constraints:**
- `weight`: Positive number in kilograms
- `recorded_at`: Timestamp of weighing (can be in the past, but not future)
- `source`: Indicates measurement method and reliability

---

### 4.8 Entity Type: `breeding`

**Naming Convention:** `camelCase` in JSON ‚ö†Ô∏è **(Inconsistent with other entities)**

**Payload Structure:**
```json
{
  "id": "uuid",
  "farmId": "uuid",
  "motherId": "uuid",
  "fatherId": "uuid | null",
  "fatherName": "string | null",
  "method": "natural | artificialInsemination",
  "breedingDate": "ISO 8601 datetime",
  "expectedBirthDate": "ISO 8601 datetime",
  "actualBirthDate": "ISO 8601 datetime | null",
  "expectedOffspringCount": "integer | null",
  "offspringIds": ["uuid"],
  "veterinarianId": "uuid | null",
  "veterinarianName": "string | null",
  "notes": "string | null",
  "status": "pending | completed | failed | aborted",
  "synced": "boolean",
  "createdAt": "ISO 8601 datetime",
  "updatedAt": "ISO 8601 datetime",
  "lastSyncedAt": "ISO 8601 datetime | null",
  "serverVersion": "string | null"
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `method` | `natural`, `artificialInsemination` |
| `status` | `pending`, `completed`, `failed`, `aborted` |

**Important Constraints:**
- `motherId`: Must reference existing female animal
- `fatherId`: Can be null if father is external to the farm
- `fatherName`: Used when `fatherId` is null
- `expectedBirthDate`: Calculated based on species gestation period
- `offspringIds`: Array of animal UUIDs born from this breeding
- `status`: `pending` until birth occurs, then `completed` or `failed`

---

### 4.9 Entity Type: `document`

**Naming Convention:** `camelCase` in JSON ‚ö†Ô∏è **(Inconsistent with other entities)**

**Payload Structure:**
```json
{
  "id": "uuid",
  "farmId": "uuid",
  "animalId": "uuid | null",
  "type": "passport | certificate | invoice | transportCert | breedingCert | vetReport | other",
  "fileName": "string",
  "fileUrl": "string",
  "fileSizeBytes": "integer | null",
  "mimeType": "string | null",
  "uploadDate": "ISO 8601 datetime",
  "expiryDate": "ISO 8601 datetime | null",
  "notes": "string | null",
  "uploadedBy": "string | null",
  "synced": "boolean",
  "createdAt": "ISO 8601 datetime",
  "updatedAt": "ISO 8601 datetime",
  "lastSyncedAt": "ISO 8601 datetime | null",
  "serverVersion": "string | null"
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `type` | `passport`, `certificate`, `invoice`, `transportCert`, `breedingCert`, `vetReport`, `other` |

**Important Constraints:**
- `animalId`: Can be null for farm-level documents
- `fileUrl`: URL to document (local or remote storage)
- `fileSizeBytes`: File size in bytes
- `mimeType`: MIME type (e.g., "application/pdf", "image/jpeg")
- `expiryDate`: Optional expiration date for certificates

---

## 5. Reference Data Endpoints

All reference endpoints use **GET** method only and require authentication.

### 5.1 Animal Species

**Endpoint:** `GET /api/reference/species`

**Query Parameters:**
- `farm_id` (optional): Filter by farm

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "string",
      "name_fr": "string",
      "name_en": "string",
      "name_ar": "string",
      "icon": "string (emoji)",
      "display_order": "integer"
    }
  ]
}
```

**Example:**
```json
{
  "id": "cattle",
  "name_fr": "Bovin",
  "name_en": "Cattle",
  "name_ar": "ÿ£ÿ®ŸÇÿßÿ±",
  "icon": "üêÑ",
  "display_order": 1
}
```

---

### 5.2 Breeds

**Endpoint:** `GET /api/reference/breeds`

**Query Parameters:**
- `species_id` (optional): Filter by species
- `farm_id` (optional): Filter by farm

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "string",
      "species_id": "string",
      "name_fr": "string",
      "name_en": "string",
      "name_ar": "string",
      "description": "string | null",
      "display_order": "integer",
      "is_active": "boolean"
    }
  ]
}
```

---

### 5.3 Medical Products

**Endpoint:** `GET /api/reference/medical-products`

**Query Parameters:**
- `farm_id` (optional): Filter by farm
- `type` (optional): Filter by type (`treatment` or `vaccine`)
- `is_active` (optional): Filter active products

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "farmId": "uuid",
      "name": "string",
      "commercialName": "string | null",
      "category": "string",
      "activeIngredient": "string | null",
      "manufacturer": "string | null",
      "form": "string | null",
      "dosage": "number | null",
      "dosageUnit": "string | null",
      "withdrawalPeriodMeat": "integer",
      "withdrawalPeriodMilk": "integer",
      "currentStock": "number",
      "minStock": "number",
      "stockUnit": "string",
      "unitPrice": "number | null",
      "currency": "string | null",
      "batchNumber": "string | null",
      "expiryDate": "ISO 8601 datetime | null",
      "storageConditions": "string | null",
      "prescription": "string | null",
      "notes": "string | null",
      "isActive": "boolean",
      "type": "treatment | vaccine",
      "targetSpecies": ["ovin | bovin | caprin"],
      "standardCureDays": "integer | null",
      "administrationFrequency": "string | null",
      "dosageFormula": "string | null",
      "vaccinationProtocol": "string | null",
      "reminderDays": ["integer"] | null,
      "defaultAdministrationRoute": "string | null",
      "defaultInjectionSite": "string | null",
      "synced": "boolean",
      "createdAt": "ISO 8601 datetime",
      "updatedAt": "ISO 8601 datetime",
      "lastSyncedAt": "ISO 8601 datetime | null",
      "serverVersion": "string | null"
    }
  ]
}
```

---

### 5.4 Vaccine References

**Endpoint:** `GET /api/reference/vaccines`

**Query Parameters:**
- `farm_id` (optional): Filter by farm
- `species` (optional): Filter by target species
- `is_active` (optional): Filter active vaccines

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "farmId": "uuid",
      "name": "string",
      "description": "string | null",
      "manufacturer": "string | null",
      "targetSpecies": ["string"],
      "targetDiseases": ["string"],
      "standardDose": "string | null",
      "injectionsRequired": "integer | null",
      "injectionIntervalDays": "integer | null",
      "meatWithdrawalDays": "integer",
      "milkWithdrawalDays": "integer",
      "administrationRoute": "string | null",
      "notes": "string | null",
      "isActive": "boolean",
      "synced": "boolean",
      "createdAt": "ISO 8601 datetime",
      "updatedAt": "ISO 8601 datetime",
      "lastSyncedAt": "ISO 8601 datetime | null",
      "serverVersion": "string | null"
    }
  ]
}
```

---

### 5.5 Veterinarians

**Endpoint:** `GET /api/reference/veterinarians`

**Query Parameters:**
- `farm_id` (required): Farm ID
- `is_active` (optional): Filter active veterinarians

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "farm_id": "uuid",
      "firstName": "string",
      "lastName": "string",
      "title": "string | null",
      "licenseNumber": "string",
      "specialties": ["string"],
      "clinic": "string | null",
      "phone": "string",
      "mobile": "string | null",
      "email": "string | null",
      "address": "string | null",
      "city": "string | null",
      "postalCode": "string | null",
      "country": "string | null",
      "isAvailable": "boolean",
      "emergencyService": "boolean",
      "workingHours": "string | null",
      "consultationFee": "number | null",
      "emergencyFee": "number | null",
      "currency": "string | null",
      "notes": "string | null",
      "isPreferred": "boolean",
      "isDefault": "boolean",
      "rating": "integer (1-5)",
      "totalInterventions": "integer",
      "lastInterventionDate": "ISO 8601 datetime | null",
      "createdAt": "ISO 8601 datetime",
      "updatedAt": "ISO 8601 datetime",
      "isActive": "boolean",
      "synced": "boolean",
      "last_synced_at": "ISO 8601 datetime | null",
      "server_version": "string | null"
    }
  ]
}
```

---

### 5.6 Campaigns

**Endpoint:** `GET /api/reference/campaigns`

**Query Parameters:**
- `farm_id` (required): Farm ID
- `completed` (optional): Filter by completion status

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "farmId": "uuid",
      "name": "string",
      "productId": "uuid",
      "productName": "string",
      "campaignDate": "ISO 8601 datetime",
      "withdrawalEndDate": "ISO 8601 datetime",
      "veterinarianId": "uuid | null",
      "veterinarianName": "string | null",
      "animalIds": ["uuid"],
      "completed": "boolean",
      "synced": "boolean",
      "createdAt": "ISO 8601 datetime",
      "updatedAt": "ISO 8601 datetime",
      "lastSyncedAt": "ISO 8601 datetime | null",
      "serverVersion": "string | null"
    }
  ]
}
```

---

### 5.7 Farm Preferences

**Endpoint:** `GET /api/reference/farm-preferences`

**Query Parameters:**
- `farm_id` (required): Farm ID

**Response (200 OK):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "farm_id": "uuid",
    "default_veterinarian_id": "uuid | null",
    "default_species_id": "string",
    "default_breed_id": "string | null",
    "synced": "boolean",
    "last_synced_at": "ISO 8601 datetime | null",
    "server_version": "string | null",
    "deleted_at": "ISO 8601 datetime | null",
    "created_at": "ISO 8601 datetime",
    "updated_at": "ISO 8601 datetime"
  }
}
```

**Important:** This is a hybrid endpoint - it loads reference data but can also be updated by the user to save preferences.

---

### 5.8 Alert Configurations

**Endpoint:** `GET /api/reference/alert-configurations`

**Query Parameters:**
- `farm_id` (required): Farm ID
- `enabled` (optional): Filter enabled alerts

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "farmId": "uuid",
      "evaluationType": "remanence | weighing | vaccination | identification | syncRequired | treatmentRenewal | batchToFinalize | draftAnimals",
      "type": "urgent | important | routine",
      "category": "string",
      "titleKey": "string",
      "messageKey": "string",
      "severity": "integer (1-3)",
      "iconName": "string",
      "colorHex": "string",
      "enabled": "boolean",
      "synced": "boolean",
      "last_synced_at": "ISO 8601 datetime | null",
      "server_version": "string | null",
      "deleted_at": "ISO 8601 datetime | null",
      "created_at": "ISO 8601 datetime",
      "updated_at": "ISO 8601 datetime"
    }
  ]
}
```

**Enums:**

| Enum | Values |
|------|--------|
| `evaluationType` | `remanence`, `weighing`, `vaccination`, `identification`, `syncRequired`, `treatmentRenewal`, `batchToFinalize`, `draftAnimals` |
| `type` | `urgent`, `important`, `routine` |

---

### 5.9 Farms

**Endpoint:** `GET /api/reference/farms`

**Query Parameters:**
- `owner_id` (optional): Filter by owner

**Response (200 OK):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "name": "string",
      "location": "string",
      "ownerId": "uuid",
      "cheptelNumber": "string | null",
      "groupId": "uuid | null",
      "groupName": "string | null",
      "createdAt": "ISO 8601 datetime",
      "updatedAt": "ISO 8601 datetime"
    }
  ]
}
```

---

## 6. Health Check

**Endpoint:** `GET /health`

**Authentication:** Not required

**Response (200 OK):**
```json
{
  "status": "ok",
  "timestamp": "ISO 8601 datetime",
  "version": "1.0.0",
  "services": {
    "database": "ok",
    "keycloak": "ok",
    "storage": "ok"
  }
}
```

**Response (503 Service Unavailable):**
```json
{
  "status": "error",
  "timestamp": "ISO 8601 datetime",
  "version": "1.0.0",
  "services": {
    "database": "error",
    "keycloak": "ok",
    "storage": "ok"
  }
}
```

---

## Appendix A: Naming Convention Inconsistency

‚ö†Ô∏è **Note:** The Flutter app has inconsistent JSON naming conventions:

**snake_case entities:**
- animal
- treatment
- vaccination
- movement
- weight

**camelCase entities:**
- lot
- breeding
- document

This inconsistency exists in the current codebase and should be documented for backend implementation. Consider standardizing to `snake_case` in a future version for consistency.

---

## Appendix B: Common HTTP Status Codes

| Code | Meaning | Usage |
|------|---------|-------|
| 200 | OK | Successful request |
| 201 | Created | Entity created successfully |
| 204 | No Content | Successful deletion |
| 400 | Bad Request | Invalid request format |
| 401 | Unauthorized | Missing or invalid token |
| 403 | Forbidden | Insufficient permissions |
| 404 | Not Found | Entity not found |
| 409 | Conflict | Version conflict (see Section 2) |
| 422 | Unprocessable Entity | Validation error |
| 500 | Internal Server Error | Server-side error |
| 503 | Service Unavailable | Service down |

---

## Appendix C: Example SYNC Flow

**Step 1: Client creates animal offline**
```json
POST /api/sync
{
  "farmId": "farm-123",
  "entityType": "animal",
  "entityId": "animal-456",
  "action": "create",
  "clientTimestamp": "2025-01-15T08:00:00Z",
  "serverVersion": null,
  "payload": {
    "id": "animal-456",
    "farmId": "farm-123",
    "current_eid": "250269801234567",
    "birth_date": "2024-03-15T00:00:00Z",
    "sex": "female",
    "status": "alive",
    "created_at": "2025-01-15T08:00:00Z",
    "updated_at": "2025-01-15T08:00:00Z"
  }
}
```

**Step 2: Backend response**
```json
{
  "success": true,
  "entityType": "animal",
  "entityId": "animal-456",
  "serverVersion": "1",
  "lastSyncedAt": "2025-01-15T08:05:00Z"
}
```

**Step 3: Client updates animal offline**
```json
POST /api/sync
{
  "farmId": "farm-123",
  "entityType": "animal",
  "entityId": "animal-456",
  "action": "update",
  "clientTimestamp": "2025-01-16T10:30:00Z",
  "serverVersion": "1",
  "payload": {
    "id": "animal-456",
    "farmId": "farm-123",
    "current_eid": "250269801234567",
    "birth_date": "2024-03-15T00:00:00Z",
    "sex": "female",
    "status": "alive",
    "visual_id": "Rouge-42",
    "created_at": "2025-01-15T08:00:00Z",
    "updated_at": "2025-01-16T10:30:00Z"
  }
}
```

**Step 4: Backend response**
```json
{
  "success": true,
  "entityType": "animal",
  "entityId": "animal-456",
  "serverVersion": "2",
  "lastSyncedAt": "2025-01-16T10:35:00Z"
}
```

---

**End of Document**
